<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><link rel=canonical type=text/html href=https://docs.trustgrid.io/tutorials/><link rel=alternate type=application/rss+xml href=https://docs.trustgrid.io/tutorials/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Guides |</title><meta name=description content="Trustgrid Network Device and API documentation"><meta property="og:title" content="Guides"><meta property="og:description" content="Trustgrid Network Device and API documentation"><meta property="og:type" content="website"><meta property="og:url" content="https://docs.trustgrid.io/tutorials/"><meta itemprop=name content="Guides"><meta itemprop=description content="Trustgrid Network Device and API documentation"><meta name=twitter:card content="summary"><meta name=twitter:title content="Guides"><meta name=twitter:description content="Trustgrid Network Device and API documentation"><link rel=preload href=/scss/main.min.6911289b253d329975de94bccbb593efad1070b6c5994295bc8c67bcf661e005.css as=style><link href=/scss/main.min.6911289b253d329975de94bccbb593efad1070b6c5994295bc8c67bcf661e005.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<link rel=stylesheet href=/css/prism.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-99793053-3"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-99793053-3")}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 469 106"><defs><style>.cls-1{fill:#6b6b6b}.cls-2{fill:#226ce0}</style></defs><title>Trustgrid-Logo-Grey</title><path class="cls-1" d="M.35 28.58H29.26V-.33H.35zM7.13 6.45H22.47V21.8H7.13z"/><path class="cls-1" d="M67.82-.33H38.9V28.58H67.82zM61 21.8H45.68V6.45H61z"/><path class="cls-1" d="M.35 67.13H29.26V38.22H.35zM7.13 45H22.47V60.35H7.13z"/><path class="cls-1" d="M106.36 38.22H77.45v12.3H67.82V41.27L85.26 23.83l-3.06-3L64.76 38.22H38.9V67.13H67.82V54.83h9.63v12.3h12.3V80.39h4.31V67.13h12.3zM61 60.35H45.68V45H61zm38.55.0H84.23V45H99.58z"/><path class="cls-1" d="M.35 105.69H29.26V76.77H.35zM7.13 83.55H22.47V98.9H7.13z"/><path class="cls-1" d="M38.9 105.69H67.82V76.77H38.9zm6.78-22.14H61V98.9H45.68z"/><path class="cls-2" d="M153.94 77.54a18.64 18.64.0 01-10.1 3.17 11.44 11.44.0 01-8.3-3c-2.12-2-3.18-5.12-3.18-9.24V44.56h-6.11V38.78h6.11V27.22H140V38.78h13.2v5.78H140V67q0 3.59 1.31 5.13a4.8 4.8.0 003.91 1.55 13.59 13.59.0 006.67-2z"/><path class="cls-2" d="M176.74 39.56A18 18 0 01186 37.07V44.4q-6.58-.24-10.66 3.42a14.51 14.51.0 00-4.64 9.85V80.39h-7.57V37.32h7.57V46.6a15.52 15.52.0 016-7"/><path class="cls-2" d="M232.34 37.32V80.39h-7.65V71.27q-4.23 9.2-16 9.36-7.48.0-11.72-4.44t-4.24-12.25V37.32h7.66V61.9q0 5.46 3 8.51a10.87 10.87.0 008.18 3.06 12.11 12.11.0 009.57-4.28 16 16 0 003.54-10.7V37.32z"/><path class="cls-2" d="M260.47 44.24a21.21 21.21.0 00-6.15-1 10.48 10.48.0 00-5.49 1.26 4.21 4.21.0 00-2.08 3.87 4.3 4.3.0 002.32 4 34.68 34.68.0 007 2.73 54.86 54.86.0 017.33 2.6 13 13 0 014.85 3.83 10.51 10.51.0 012 6.67 10.58 10.58.0 01-4.6 9.29 19.65 19.65.0 01-11.44 3.17 28.35 28.35.0 01-9.32-1.55 21.07 21.07.0 01-7.61-4.39l2.85-5.54a20.07 20.07.0 006.63 3.91 22 22 0 007.69 1.47 11.45 11.45.0 006-1.39 4.61 4.61.0 002.28-4.23 4.82 4.82.0 00-2.4-4.4 32.85 32.85.0 00-7.29-2.93 48.4 48.4.0 01-7-2.48 12.43 12.43.0 01-4.64-3.71A10 10 0 01239.5 49q0-6 4.4-9a19.07 19.07.0 0111-3 27.13 27.13.0 017.69 1.1 23 23 0 016.56 3l-2.77 5.78a26 26 0 00-5.9-2.6"/><path class="cls-2" d="M303.42 77.54a18.64 18.64.0 01-10.1 3.17 11.44 11.44.0 01-8.3-3c-2.12-2-3.18-5.12-3.18-9.24V44.56h-6.11V38.78h6.11V27.22h7.65V38.78h13.19v5.78H289.49V67c0 2.39.44 4.1 1.3 5.13a4.81 4.81.0 003.91 1.55 13.62 13.62.0 006.68-2z"/><path class="cls-1" d="M352.92 36.34V76.48a19.18 19.18.0 01-3 10.71 19.61 19.61.0 01-8.43 7.08A29.79 29.79.0 01329 96.75a36.74 36.74.0 01-10.66-1.54 34 34 0 01-9-4.16l5.05-10a25.68 25.68.0 006.51 3.17 22.5 22.5.0 007.08 1.14 12.11 12.11.0 007.74-2.27 7.52 7.52.0 002.85-6.2V72.16Q334.12 77.95 326 78a17.69 17.69.0 01-16.41-10.14 24.71 24.71.0 01-2.4-11.12 24.42 24.42.0 012.32-10.91A17.35 17.35.0 01316 38.46a17.92 17.92.0 019.61-2.61A17.42 17.42.0 01333 37.36a14.36 14.36.0 015.5 4.35V36.34zM336.07 64.51a11 11 0 002.44-7.41 11.16 11.16.0 00-2.44-7.49 8.69 8.69.0 00-12.91.0 11 11 0 00-2.48 7.45 10.85 10.85.0 002.48 7.41 8.18 8.18.0 006.47 2.85 8.08 8.08.0 006.44-2.85"/><path class="cls-1" d="M383.9 37.8a16.63 16.63.0 018.26-2V49c-.49.0-1.22-.08-2.2-.08a13.4 13.4.0 00-8.3 2.4A9.18 9.18.0 00378 57.92V80.39H363.5v-44H378v7.33a16 16 0 015.9-5.87"/><path class="cls-1" d="M411.09 18.22a7.55 7.55.0 012.16 5.58 7.59 7.59.0 01-2.16 5.54 8 8 0 01-11 0 7.59 7.59.0 01-2.16-5.54 7.55 7.55.0 012.16-5.58 8.1 8.1.0 0111 0M398.51 36.34h14.41V80.39H398.51z"/><path class="cls-1" d="M468.45 20V80.39H454v-5.7a14.92 14.92.0 01-5.58 4.68A16.94 16.94.0 01440.93 81a20.15 20.15.0 01-10.75-2.85 19.16 19.16.0 01-7.2-8 26.51 26.51.0 01-2.57-11.93 25.77 25.77.0 012.53-11.72A18.6 18.6.0 01430 38.62a20.05 20.05.0 0110.59-2.77 17.24 17.24.0 017.61 1.63A16.19 16.19.0 01454 42.12V20zm-17.1 46.5A11.77 11.77.0 00454 58.57a11.76 11.76.0 00-2.61-8 8.58 8.58.0 00-6.84-3 8.67 8.67.0 00-6.88 3.05A11.69 11.69.0 00435 58.57a11.68 11.68.0 002.64 7.93 8.68 8.68.0 006.88 3.06 8.53 8.53.0 006.84-3.06"/><path class="cls-2" d="M99.58 21.8H84.23V6.46H99.58zM106.36-.33H77.45V28.59h28.91z"/><path class="cls-2" d="M99.58 98.9H84.23V83.55H99.58zm6.78-22.13H77.45v28.92h28.91z"/></svg></span><span class=navbar-brand__name></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/getting-started/><span>Getting Started</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/tutorials/><span class=active>Guides</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/help-center/><span>Help Center</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/release-notes/><span>Release Notes</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.674c37f3ef288b653a841457ff50f369.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/tutorials/>Return to the regular view of this page</a>.</p></div><h1 class=title>Guides</h1><ul><li>1: <a href=#pg-1a52d97bfae1220751b6aefe55e117a3>Management Operations</a></li><ul><li>1.1: <a href=#pg-65a774681ff25abc59ca1c6d214c4dbf>Changing Node Status (Enabling / Disabling)</a></li><li>1.2: <a href=#pg-32a3c49a044a0d63e244ed4e84bb8987>Restart the Trustgrid Service on a Node</a></li><li>1.3: <a href=#pg-4fdb29327843b1e40916543c5a96a218>Reboot a Node</a></li><li>1.4: <a href=#pg-5d88ce6e85d4221c2835e72919e32413>Upgrading Trustgrid Nodes</a></li><li>1.5: <a href=#pg-45db892ea845146c8a23e225999b01c8>Deleting Trustgrid Nodes</a></li><li>1.6: <a href=#pg-727faa90317dd5d7bb47e2774b7e3100>Deleting Trustgrid Clusters</a></li></ul><li>2: <a href=#pg-e46608cfe2de1600ced3f1d3a8ac0a07>Operations Runbook</a></li><ul><li>2.1: <a href=#pg-04cdaed49b19026180114b6a895715ae>Cluster Failover Response</a></li><li>2.2: <a href=#pg-f1997f9fc525dd18c259eee4c479bdbb>Control Plane Disconnect</a></li><li>2.3: <a href=#pg-76ca6a98fdf21fa75cb27a45b626d470>Node Down Response</a></li><li>2.4: <a href=#pg-ac421cd7a8e4dc3a9177045b633b3556>Site Failover</a></li></ul><li>3: <a href=#pg-cd85acb6571e4c62ef3a6a45bd392e8b>Changing the WAN Interface IP</a></li><li>4: <a href=#pg-6cf6f9d5da8c1aec9f1d6c776bfadad2>Configure FTP and FTPS</a></li><li>5: <a href=#pg-3a987d5d26cd7dfc26cf2a8db95ac3a7>Configure Layer 3 VPN</a></li><li>6: <a href=#pg-61c9a49ae9f7259a162c4399588119f6>Configure WireGuard on an Edge Node</a></li><li>7: <a href=#pg-e552eb1d84853a74b1be90527c1b7213>Deployments</a></li><ul><li>7.1: <a href=#pg-b4372d0404394d7880ccab62b7398289>AWS Requirements for HA Wireguard Cluster</a></li><li>7.2: <a href=#pg-babdda31d36538ba18809318bb6e3d66>AWS Requirements for HA ZTNA Gateway Cluster</a></li><li>7.3: <a href=#pg-ecf5e347f65f7bfb202ac608a2e20f2d>Configure HA Trustgrid Gateway Cluster in AWS</a></li><li>7.4: <a href=#pg-ced9fd24d3e032d3def2aca0be2e6355>Deploy a Trustgrid Node AMI in AWS</a></li><li>7.5: <a href=#pg-f9b4bb0bebfa94e31f6dfbaf1cde6df3>Deploy to Azure</a></li><li>7.6: <a href=#pg-ef9aa21319b8de0c7d36e66cb0663a67>Deploy to vSphere</a></li><li>7.7: <a href=#pg-88919b6dfe830981110e41698ff5dbac>On a Stick Configuration</a></li></ul><li>8: <a href=#pg-1fca8ca5bcf5316ac2d6ec6d6750f674>Enable SAML with Okta</a></li><li>9: <a href=#pg-becedbc7d009f334b2a4971e441bf158>Find the IP Adress of a Node</a></li><li>10: <a href=#pg-e958de7e80893c30582f24e6a0941be7>Gateway Tools</a></li><ul><li>10.1: <a href=#pg-8bb544fcf510b6cbff2d42ef2a56ae83>Monitoring Network Hops to Peers</a></li><li>10.2: <a href=#pg-45e1ca7a969bfc66666b285166ff38f7>Ping Remote Node</a></li></ul><li>11: <a href=#pg-5f10d06e90d426e0577b9ecf0948abf8>Limit Node Functionality to Current Public IP</a></li><li>12: <a href=#pg-18be48e8b87be45f32e42c6a76ceb0dd>Remote Tools</a></li><ul><li>12.1: <a href=#pg-645ef0365cda0722e81c624f870ffe98>Ping Remote Virtual Host</a></li><li>12.2: <a href=#pg-51c069fcffd3733d792696227fec123b>Sniff Interface Traffic</a></li><li>12.3: <a href=#pg-ff566379924693f5bd0c70a6b09efa37>TCP Port Test</a></li><li>12.4: <a href=#pg-099456662cc8248096dacdebd11257e5>View Virtual Route Table</a></li></ul><li>13: <a href=#pg-ec55fe3fdd6af3991bc421eeffbaf0b2>Trustgrid Local Console Utility</a></li><li>14: <a href=#pg-b3b99a158d5908d67bad599d7a396e50>Trustgrid Local UI for Node IP Reconfiguration</a></li></ul><div class=content><div class="pageinfo pageinfo-primary"><p>Guides are written to help users leverage Trustgrid in different use cases. Don&rsquo;t see what you need? <a href=https://github.com/trustgrid/docs/issues/new>Let us know</a> and we&rsquo;ll add it to the list.</p></div></div></div><div class=td-content><h1 id=pg-1a52d97bfae1220751b6aefe55e117a3>1 - Management Operations</h1></div><div class=td-content><h1 id=pg-65a774681ff25abc59ca1c6d214c4dbf>1.1 - Changing Node Status (Enabling / Disabling)</h1><div class=lead>Describes the process of enabling or disabling a Trustgrid node and the impacts of such a change</div><p>Trustgrid nodes can be in two states:</p><ul><li>Enabled - In this state the node will connected to the Trustgrid Control Plane and any Data Plane gateways the node is configured to use.</li><li>Disabled - This is a reduced functionality state that cause the node to only attempt to connect to the Trustgrid control plane. It can be managed to a limited extent but many other Trustgrid features will not function in this state</li></ul><p>Disabling a node allows for additional security if a device is in transport and can also be used as an easily reversible way of verifying a node is no longer in use before fully deleting the node.</p><div class="alert alert-warning" role=alert>Changing the node status will trigger a restart of the Trustgrid node service.</div><h2 id=disablingenabling-from-info-tab>Disabling/Enabling from Info Tab</h2><p>If disabling or enabling a single node you can:</p><ol><li>Navigate to that node in the Trustgrid portal.</li><li>Open the <strong>Info</strong> tab by clicking the dropdown in the top-right, or hitting the <code>`</code> key.</li><li>From the Status dropdown change to Disable or Enable<figure class=centered-image><img src=info-tab-status.png alt style=display:block;margin-left:auto;margin-right:auto;width:70%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Info tab with Status dropdown</figcaption></figure></li></ol><h2 id=disablingenabling-from-nodes-table>Disabling/Enabling from Nodes Table</h2><p>If disabling or enabling multiple nodes it is easier to do so from the Nodes table</p><ol><li>Navigate to the nodes table.</li><li>(Optional) Use the search box to filter the displayed nodes.<div class="alert alert-warning" role=alert>Note that if you change this any selected nodes will be de-selected.</div></li><li>Use the checkbox on the left to select the nodes you wish to disable or enable.</li><li>From the Actions dropdown select either <strong>Enable</strong> or <strong>Disable</strong><figure class=centered-image><img src=nodes-table-status.png alt style=display:block;margin-left:auto;margin-right:auto;width:60%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Status actions on Nodes table</figcaption></figure></li></ol><h2 id=disablingenabling-via-terraform>Disabling/Enabling via Terraform</h2><p>Nodes can be enabled or disabled via the Trustgrid published Terraform provider using the <a href=https://registry.terraform.io/providers/trustgrid/tg/latest/docs/resources/node_state/ target=_blank>tg_node_state</a> resource.</p><div class="alert alert-info" role=alert>The Trustgrid API refers to this state via the <code>status</code> attribute. The value <code>ACTIVE</code> means the node is <strong>enabled</strong> and the value <code>INACTIVE</code> indicates the node is currently <strong>disabled</strong></div></div><div class=td-content style=page-break-before:always><h1 id=pg-32a3c49a044a0d63e244ed4e84bb8987>1.2 - Restart the Trustgrid Service on a Node</h1><div class=lead>Describes how to restart the Trustgrid service on a node appliance</div><div class="pageinfo pageinfo-primary"><p>Restarting the Trustgrid service is faster than a full node reboot and resolves many non-recurring problems.</p></div><ol><li><p>Go to the <code>Node</code> detail page for the node affected.</p></li><li><p>Select <code>Restart</code> located in the top right corner of the page</p></li></ol><p><img src=restart1.png alt=img></p><ol start=3><li>After clicking, type in the name of the node and click <code>Confirm</code> to execute the action</li></ol><p><img src=execute2.png alt=img></p><ol start=4><li><p>the node agent will restart (Node host will not restart)</p></li><li><p>Expect the node to alert for disconnection and connection.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-4fdb29327843b1e40916543c5a96a218>1.3 - Reboot a Node</h1><div class=lead>Describes how to completely reboot a node appliance including the operating system</div><ol><li>Click on the Node from the node page you wish to reboot</li><li>Select <code>Reboot</code> from the top right corner of the page</li></ol><p><img src=reboot.png alt=img></p><ol start=3><li>Type in the name of the node in the text box, and click the confirmation button</li></ol><p><img src=execute.png alt=img></p><ol start=4><li>The node will reboot within 60 seconds</li><li>Node agent will start automatically on reboot</li><li>Expect the node to alert for disconnect/connect</li><li>Does not require a cloud gateway</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-5d88ce6e85d4221c2835e72919e32413>1.4 - Upgrading Trustgrid Nodes</h1><h2 id=how-a-node-appliance-upgrades>How a Node Appliance Upgrades</h2><p>The upgrade process will:</p><ol><li>Upgrade the Trustgrid application package. As part of this process the node will backup the current running version.</li><li>Apply security updates to install operating system packages.</li><li>Reboot the Trustgrid node appliance.</li></ol><p>For details on what this looks like from a network level see the <a href=https://docs.trustgrid.io/help-center/kb/upgrade-process/>Node Upgrade Process KB</a> article.</p><h2 id=frequently-asked-questions>Frequently Asked Questions</h2><ul><li><strong>Is the upgrade disruptive?</strong> - Yes. While the appliance is upgrading services will remain available, though performance may be degraded. However, <strong>the reboot step will make all services unavailable</strong> until the appliance fully boots and starts the Trustgrid service. Typically this takes a few minutes depending on the underlying hardware.</li><li><strong>How long will the upgrade take?</strong> - This is highly variable but typically this takes between 10 minutes and an hour. Below are a list of things that influence how long the upgrade takes:<ul><li>Internet bandwidth - This determines how quickly the node can download the updates.</li><li>Time since previous update - The longer a node goes without updating the more security packages are likely to be required.</li><li>CPU and disk performance - The upgrade process involves significant CPU processing and to a lesser extent disk I/O. The upgrade process is single-threaded, so core speed is more important than number of cores.</li></ul></li></ul><h2 id=best-practices>Best Practices</h2><ul><li>Upgrade nodes regularly to ensure access to the latest features and security updates</li><li>For clustered nodes:<ul><li>Upgrade the standby node</li><li>Change the standby node to be the <a href=https://docs.trustgrid.io/docs/clusters/#configured-master>configured master/active</a> and wait for it to claim this role.</li><li>Upgrade the new standby node in the cluster</li></ul></li><li>Utilize an <a href=https://docs.trustgrid.io/docs/alarms/alert-suppression/#define-alert-suppression-window>Alert Suppression Window</a> to reduce the number of alarms generated if upgrading many nodes.</li></ul><h2 id=required-permissions>Required Permissions</h2><p>In order to perform the below actions a user must have a <a href=https://docs.trustgrid.io/docs/user-management/policies/>policy</a> applied with the following permissions to the nodes that will be upgraded.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>  <span style=color:#4e9a06>&#34;statements&#34;</span><span style=color:#a40000>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;effect&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;allow&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;actions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;nodes::read&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;nodes::upgrade&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;nodes::manage&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;nodes::service:node-upgrade&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;portal::access&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>]</span><span style=color:#a40000>,</span>
</span></span></code></pre></div><div class="alert alert-info" role=alert>The above is only a partial policy. Use the policy creator to define a complete policy</div><h2 id=upgrading-a-single-node>Upgrading a Single Node</h2><ol><li>Navigate to the node that will be upgraded.</li><li>From the tool bar click the Upgrade button.<figure class=centered-image><img src=node-upgrade-button.png alt="Toolbar showing an Upgrade (surrounded by a red rectangle), Refresh and Info buttons." style=display:block;margin-left:auto;margin-right:auto;width:40%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Upgrade button</figcaption></figure></li><li>When prompted enter the node&rsquo;s name and click confirm.<figure class=centered-image><img src=node-upgrade-confirm.png alt="Dialogue asking to enter the node name to confirm" style=display:block;margin-left:auto;margin-right:auto;width:40%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Node upgrade confirmation</figcaption></figure></li><li>A dialogue will indicate the command was successfully sent.<figure class=centered-image><img src=single-node-upgrade-report.png alt="Dialogue stating 'Upgrade in progress" style=display:block;margin-left:auto;margin-right:auto;width:40%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Node upgrade response</figcaption></figure></li></ol><h2 id=upgrading-multiple-nodes>Upgrading Multiple Nodes</h2><ol><li>Navigate to the <a href=https://docs.trustgrid.io/docs/nodes/#node-list-view>Nodes table</a>.</li><li>(Optional) Use the search box or <a href=https://docs.trustgrid.io/docs/nodes/#applying-a-tag-filter-to-the-nodes-table>apply a tag filter</a> to filter the displayed nodes.<div class="alert alert-info" role=alert>Note: if you change the search or tag filter any selected nodes will be deselected.</div></li><li>Use the check boxes to select the desired nodes.<figure class=centered-image><img src=multi-node-select.png alt="Nodes table showing two nodes selected" style=display:block;margin-left:auto;margin-right:auto;width:40%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Nodes table</figcaption></figure></li><li>From the actions dropdown select Upgrade.<figure class=centered-image><img src=nodes-upgrade-action.png alt="Action dropdown menu with red box around Upgrade option" style=display:block;margin-left:auto;margin-right:auto;width:40%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Action > Upgrade</figcaption></figure></li><li>When prompted, confirm you want to proceed with the bulk upgrade.<figure class=centered-image><img src=multi-node-upgrade-confirm.png alt style=display:block;margin-left:auto;margin-right:auto;width:50%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Confirm bulk upgrade</figcaption></figure></li><li>A table will be presented showing the status of each node upgrade request.<figure class=centered-image><img src=multi-node-upgrade-report.png alt="Upgrade Operation Report table showing two nodes were requested to upgrade and both are in progress" style=display:block;margin-left:auto;margin-right:auto;width:70%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Upgrade Operation Report</figcaption></figure></li></ol><h2 id=monitoring-upgrade-progress>Monitoring Upgrade Progress</h2><p>You can monitor the upgrade status from a node&rsquo;s Info tab.<figure class=centered-image><img src=upgrade-status-inprog.png alt style=display:block;margin-left:auto;margin-right:auto;width:75%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Info tab, Upgrade in Progress</figcaption></figure></p><p>There are two fields<table><thead><tr><th>Field Name</th><th>Description</th></tr></thead><tbody><tr id=upgrade-status><th>Upgrade Status</th><td><p>Shows the most recent status of an upgrade operation on this node. Possibly values are:</p><ul><li>In Progress</li><li>Completed</li><li>Failed</li></ul></td></tr><tr id=completion-time><th>Completion Time</th><td>Shows a timestamp for the last time an upgrade operation completed.</td></tr></tbody></table><div class="alert alert-info" role=alert>Note: if an upgrade is currently <strong>In Progress</strong>, then this will be the completion time of the prior upgrade operations</div></p><figure class=centered-image><img src=upgrade-status-completed.png alt style=display:block;margin-left:auto;margin-right:auto;width:80%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Example of Completed upgrade status</figcaption></figure></div><div class=td-content style=page-break-before:always><h1 id=pg-45db892ea845146c8a23e225999b01c8>1.5 - Deleting Trustgrid Nodes</h1><div class=lead>Describes the process of deleting Trustgrid nodes along with best practices</div><div class="alert alert-danger" role=alert><strong>Be advised:</strong> Deleting a node is an irreversible action. Delete nodes only after you are certain it is no longer needed.</div><h2 id=best-practices>Best Practices</h2><ul><li><a href=https://docs.trustgrid.io/tutorials/management-tasks/changing-node-status/>Disable the node(s)</a> for several days prior to deleting. This way if it is discovered that it is still needed it is simple to re-enable.</li><li><a href=https://docs.trustgrid.io/docs/nodes/tags/prod-status-tag/>Update any status tag</a> to indicate the node(s) is being decommissioned.</li><li>Before deleting, <a href=https://docs.trustgrid.io/docs/domain/virtual-networks/routes/#deleting-virtual-network-routes>remove any virtual network routes</a> with the node as a destination. While these can be removed later, they will be easier to find while the node is still listed as the destination.</li></ul><h2 id=deleting-nodes>Deleting Nodes</h2><ol><li>If the node(s) is not already disabled, <a href=https://docs.trustgrid.io/tutorials/management-tasks/changing-node-status/>disable the node(s)</a> <strong>See best practice above before proceeding</strong></li><li>If the node(s) is a member of a cluster, <a href=https://docs.trustgrid.io/docs/clusters/manage-members/#remove-member>remove the node(s) from the cluster</a>.</li><li>Navigate to the Nodes table and select the target node(s).<div class="alert alert-info" role=alert>Optionally, Use the search to filter the displayed nodes.</div></li><li>From the Actions menu select the Delete option.<figure class=centered-image><img src=delete-node-action.png alt style=display:block;margin-left:auto;margin-right:auto;width:30%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Delete node action</figcaption></figure><ol><li>If deleting a single node, you will be prompted to enter the name of the node about to be deleted to confirm.</li><li>If deleting multiple nodes, you will be prompted to enter <code>DELETE</code> to confirm.</li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-727faa90317dd5d7bb47e2774b7e3100>1.6 - Deleting Trustgrid Clusters</h1><div class=lead>Describes the process of deleting Trustgrid Cluster along with best practices</div><div class="alert alert-danger" role=alert><strong>Be advised:</strong> Deleting a cluster is an irreversible action. Delete clusters only after you are certain they are no longer needed.</div><h2 id=best-practices>Best Practices</h2><ul><li><a href=https://docs.trustgrid.io/docs/clusters/manage-members/#remove-member>Remove all members</a> for a period of time to ensure the configuration is no longer needed.</li><li><a href=https://docs.trustgrid.io/docs/nodes/tags/prod-status-tag/>Update any status tag</a> to indicate the cluster(s) is being decommissioned.</li><li>Before deleting, <a href=https://docs.trustgrid.io/docs/domain/virtual-networks/routes/#deleting-virtual-network-routes>remove any virtual network routes</a> with the cluster as a destination. While these can be removed later, they will be easier to find while the cluster is still listed as the destination.</li></ul><h2 id=deleting-clusters>Deleting Clusters</h2><ol><li><a href=https://docs.trustgrid.io/docs/clusters/manage-members/#remove-member>Remove the node(s) from the cluster</a> and <a href=https://docs.trustgrid.io/docs/domain/virtual-networks/routes/#deleting-virtual-network-routes>remove any virtual network routes</a> with the cluster as a destination. <strong>See best practices above</strong></li><li>Navigate to the Cluster table and select the target cluster(s).<div class="alert alert-info" role=alert>Optionally, Use the search to filter the displayed clusters.</div></li><li>From the Actions menu select the Delete option.<figure class=centered-image><img src=delete-cluster-action.png alt style=display:block;margin-left:auto;margin-right:auto;width:30%><figcaption style=text-align:center;margin-top:.5rem;font-weight:lighter>Delete cluster action</figcaption></figure><ol><li>If deleting a single cluster, you will be prompted to enter the fully-qualified domain name (fqdn) of the cluster about to be deleted to confirm.</li><li>If deleting multiple clusters, you will be prompted to enter <code>DELETE</code> to confirm.</li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-e46608cfe2de1600ced3f1d3a8ac0a07>2 - Operations Runbook</h1></div><div class=td-content><h1 id=pg-04cdaed49b19026180114b6a895715ae>2.1 - Cluster Failover Response</h1><div class="pageinfo pageinfo-primary"><p>When the active (master) member of the <a href=https://docs.trustgrid.io/docs/clusters/>cluster</a> goes unhealthy the standby member will take over the active role. This process should be automatic and not require manual intervention. However, in certain circumstances, such as the unexpected failover of a public gateway, it is worth investigating to confirm traffic is in a healthy state.</p></div><h3 id=possible-messages>Possible Messages</h3><ul><li><p>Master role assumed - failover</p><ul><li>Indicates the master role has moved from the designated master (primary) to the backup/secondary <a href=https://docs.trustgrid.io/docs/nodes/>node</a></li></ul></li><li><p>Master role reclaimed by expected master</p><ul><li>Indicates the master role has returned to the designated master</li></ul></li></ul><h3 id=failover-process>Failover Process</h3><p>Below is a brief description events that occur during a failover process:</p><ul><li><p>The <a href=https://docs.trustgrid.io/docs/nodes/>node</a> assuming the master role will ARP to the network that it now owns the <a href=https://docs.trustgrid.io/docs/clusters/>Cluster</a> Virtual IP (VIP)</p></li><li><p>The <a href=https://docs.trustgrid.io/docs/domain/virtual-networks/routes/>Domain route</a> table will update that the assuming <a href=https://docs.trustgrid.io/docs/nodes/>node</a> should receive all traffic for the <a href=https://docs.trustgrid.io/docs/clusters/>cluster</a> (<em>clustername-master</em>)</p></li><li><p>The assuming <a href=https://docs.trustgrid.io/docs/nodes/>node</a> will load all NAT entries associated with the <a href=https://docs.trustgrid.io/docs/clusters/>cluster</a></p></li></ul><h3 id=response-process>Response Process</h3><p>After a failover or failback it is necessary to verify that traffic is flowing appropriately.</p><ol><li><p>Login to the portal and navigate to the affected <a href=https://docs.trustgrid.io/docs/clusters/>cluster’s</a> page</p></li><li><p>Verify that only a single <a href=https://docs.trustgrid.io/docs/nodes/>node</a> shows as master</p></li><li><p>On the <code>Configuration</code> → <code>Network</code> tab note the <a href=https://docs.trustgrid.io/docs/clusters/>cluster</a> VIP</p></li></ol><p><img src=cluster-virtual-ip2.png alt=img></p><ol><li><p>Click on the indicated current master</p><p>a. Verify the VPN Route Table shows</p><pre><code>i. Navigate to the `Configuration` → `VPN` tab

ii. Launch the &quot;View Virtual Route Table&quot; tool
</code></pre><p><img src=virtual-network-tools.png alt=img></p><pre><code>iii. Verify that routes show as “available true”
</code></pre><p><img src=routing-tables.png alt=img></p><pre><code>   1. If the cluster is a gateway cluster there may be many routes and not all be active, just confirm many show as available.

   2. The route to the management VIP for the other node in the cluster will always be false.
</code></pre><p>b. Verify traffic is flowing through the appropriate node.</p><pre><code>i. Navigate to the `Configuration` → `Network` tab

ii. Confirm the interface associated with the Cluster VIP is selected

   3. For single interface nodes: ETH0 / Network Adapter 1 - WAN Adapter

   4. For dual interface nodes: ETH1 / Network Adapter 2 - LAN Adapter

iii. Open the `Sniff Interface Traffic` tool.

    5. Set the filter to “host clusterVIP” without quotes and replacing clusterVIP with the appropriate Cluster virtual IP. Click `start session`.

    6. Confirm that you see traffic flowing through the interface. **Continue monitoring for several minutes to confirm the traffic is maintained.**

    7. Leave the Sniff Interface Tool running while completing the next step

iv. Repeat steps i-iii on the node that **is not** currently indicated as the master.

    1.You want to verify there is **no traffic for the cluster VIP running through the non-master node**.

    8. You may see a periodic ARP from the cluster master, but that should be it.
</code></pre><ol><li><p>Compare traffic volume before and after the failover</p><p>a. If the event was a failover and failback compare traffic from the current master</p><p>b. If the event was a failover but has not failed back you will need to compare traffic volume on the current master to the volume on the previous master</p><pre><code> i. e.g if traffic failed from node1 to node2, compare node1’s traffic prior to the failover to the volume of traffic on node2 after the failover
</code></pre></li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-f1997f9fc525dd18c259eee4c479bdbb>2.2 - Control Plane Disconnect</h1><blockquote><p>When the Control Plane is disconnected there is no way to utilize remote tools to resolve the issue so you will need to contact the End-user technical resource for the site to troubleshoot</p></blockquote><p>When troubleshooting the control plane it is a good idea to familiarize yourself with the [Edge Node Startup & Update Communication Process].</p><table><thead><tr><th>Network Requirements</th></tr><tr><td>In order to connect to the Trustgrid Control Plane, the following <strong>outbound traffic</strong> must be allowed from the node’s configured primary interface IP address<br><ul><li>TCP Port 443 and TCP/UDP 8443 to:</li><ul><li>35.171.100.16/28</li><li>34.223.12.192/28</li></ul></li><li>TCP/UDP Port 53 to the configured DNS servers. These DNS servers must be able to resolve DNS requests for the trustgrid.io domain</li></ul></table><ol><li><p>Triage the total site connectivity to see if actions can be taken to restore functionality for the edge site while troubleshooting the specific node</p></li><li><p>Confirm with the site tech:</p><p>a. There are no known power or internet issues at the site</p><p>b. No changes have been made to any firewalls between the Trustgrid node and the internet (if applicable). In order to connect the Trustgrid node must have access to the Network Requirements defined above.</p></li><li><p>Have the site tech attempt to ping the inside interface IP address(es) to see if the device is showing as powered up and online. If the site is using a single-interface configuration this would be the Network Adapter 1 - WAN Interface IP(s) in the portal.</p><p>a. If the ping is successful you have determined the device has power and that the operating system and Trustgrid software are running. In this case, you can focus on internet side issues.</p><p>b. If the ping fails, work with the site tech to:</p><pre><code> i. Confirm the node is powered on

 ii. Connect directly to the network of the inside interface and attempt ping from there. They should also connect directly to the inside interface and statically configure an IP in the same network.
</code></pre></li><li><p>Attempt power cycling the node by removing power and returning from physical devices or using the hypervisor management tools for virtual nodes.</p></li><li><p>Connect to the console of the device</p><p>a. A normal node looks something like this</p></li></ol><p><img src=normal-node.png alt=img></p><pre><code>i. Work with the onsite tech to login to the Trustgrid Local Console Utility.  This tools will display connectivity status and allow you to alter the WAN/outside IP settings if needed.
</code></pre><p>b. If you see a screen like below attempt rebooting the device to restore connectivity. If that works contact Trustgrid support so we can investigate further.</p><p><img src=more-node.png alt=img></p><ol><li><p>Disconnect the cable from the WAN/Outside port of the Trustgrid node and connect to a laptop NIC. Statically assign the same IP and DNS settings that the Trustgrid node is using. Confirm the following:</p><p>a. Using <code>nslookup</code> or <code>dig</code> to confirm you can resolve zuul.trustgrid.io</p><p>b. Open a browser and navigate to <a href=https://zuul.trustgrid.io:8443>https://zuul.trustgrid.io:8443</a></p><pre><code> i. If the device can connect to that server and port you should see a warning like this because Trustgrid uses its own Certificate Authority (CA)
</code></pre></li></ol><p><img src=link.png alt=img></p><pre><code>    1. Click `Not Secure` and then click `Certificate (invalid)`
</code></pre><p><img src=certificate-invalid.png alt=img></p><pre><code>    1. You should expect to see a chain like the below.
</code></pre><p><img src=chain.png alt=img></p><pre><code>        a. If there are any different certificates or CAs that indicates something like DPI-SSL/HTTPS Proxy is interfering with the handsake.  See [this page] for resolution requirements.

    ii. If the browser says it cannot connect this indicates a firewall or routing issue upstream.
</code></pre><ol><li><p>If possible, capture traffic between the Trustgrid node and the internet. Specifically, the capture should filter to only see traffic from the Trustgrid node’s IP address and TCP port 8443 and TCP/UDP port 53. Common problems seen include:</p><p>a. Blocked DNS - Edge Node Behavior When DNS Fails</p><p>b. Blocked port 8443 to the Trustgrid Networks - Edge Node Behavior When Port 8443 to Trustgrid Public Networks is Blocked</p><p>c. DPI-SSL or HTTPS altering the TLS certificate chain - Edge Node Behavior When SSL / TLS Certificate is Altered</p></li></ol><h1 id=need-proper-links-to-use-and-need-to-find-how-to-add-links-to-indent-format><strong>NEED PROPER LINKS TO USE AND NEED TO FIND HOW TO ADD LINKS TO INDENT FORMAT</strong></h1></div><div class=td-content style=page-break-before:always><h1 id=pg-76ca6a98fdf21fa75cb27a45b626d470>2.3 - Node Down Response</h1><div class="pageinfo pageinfo-primary"><p>This process is intended to help customer support personnel quickly identify the scope of a <a href=https://docs.trustgrid.io/docs/nodes/>node</a> down problem and get services back online as quickly as possible.</p></div><h3 id=node-down-triage>Node Down Triage</h3><h4 id=triage-checklist>Triage Checklist</h4><ul><li><p>Determine Production Status of the Trustgrid Node</p></li><li><p>Confirm High Availability or Disaster Recover is Functioning</p><ul><li><p>If clustered, is the partner active and working</p></li><li><p>If there is a second site, confirm if it is active</p></li></ul></li><li><p>Determine the type of outage (Control Plane, Data Plane or Both)</p></li></ul><h3 id=determine-production-status-of-the-trustgrid-node>Determine Production Status of the Trustgrid Node</h3><p>Use the <a href=https://docs.trustgrid.io/docs/nodes/tags/prod-status-tag/%7D>Production Status Tags</a> to determine if the <a href=https://docs.trustgrid.io/docs/nodes/>node</a> is in use and expected to be online.</p><h3 id=confirm-high-availability-or-disaster-recover-is-functioning>Confirm High Availability or Disaster Recover is Functioning</h3><p>Before troubleshooting why a <a href=https://docs.trustgrid.io/docs/nodes/>node</a> is down we should determine if the services it provided can be provided in the interim by a cluster member or devices at a secondary/disaster-recovery site.</p><h5 id=is-the-node-a-cluster-member>Is the Node a Cluster Member</h5><ul><li><p>Check if partner member is online:</p><ul><li><p>If Yes:</p><pre><code>- Confirm partner member is now active and operating normally.

- The issue is limited to this specific Node. This could be its power input, the hardware or operating system, configuration, or its internet connection (if different than partner member).
</code></pre></li><li><p>If No:</p><pre><code>- Possible site-level issue including power or internet provider

- Proceed to Secondary / DR Site
</code></pre></li></ul></li></ul><h5 id=is-there-a-secondary--dr-site-for-this-nodecluster>Is there a Secondary / DR Site for this Node/Cluster?</h5><ul><li><p>Are the <a href=https://docs.trustgrid.io/docs/nodes/>nodes</a> deployed at the secondary site online in the Trustgrid?</p><ul><li><p>If No:</p><pre><code>- Confirm nodes for other end-user sites are not also offline which might indicate a wider spread issue. Escalate to Trustgrid Support if you suspect a major issue with the Trustgrid system.

- If limited to a single customer it is recommended to contact that customer immediately. They may be experiencing an outage or performing maintenance.
</code></pre></li><li><p>If Yes:</p><pre><code>- If the customer is configured for Automatic Failover between sites, verify that traffic is flowing through the active member at the secondary site.

- If the customer is configured for Manual Failover you will need to adjust the route destination to point to the secondary site.
</code></pre></li></ul></li></ul><h3 id=determine-connectivity-status-of-the-trustgrid-node>Determine Connectivity Status of the Trustgrid Node</h3><p>Because Trustgrid provides independent control and data planes, there are a few ways it can manifest as “down”:</p><tr id=control-plane-down><th>Control Plane Down</th><td>The <a href=https://docs.trustgrid.io/docs/nodes/>node</a> appears offline from within the Trustgrid portal. This indicates that the <a href=https://docs.trustgrid.io/docs/nodes/>node</a> shutdown or has not sent a heartbeat notification to Trustgrid within the past 10 minutes.</td></tr><tr id=data-plane-down><th>Data Plane Down</th><td>The <a href=https://docs.trustgrid.io/docs/nodes/>node</a> appears online from within the portal but reports it is unable to connect to one or more gateway nodes. This can be indicated by the Data Plane Status indicator when viewing the <a href=https://docs.trustgrid.io/docs/nodes/>node</a> in the portal, or by receiving a “Gateway Connectivity Health Check” failure <a href=https://docs.trustgrid.io/docs/alarms/events/>event</a> notification. Both of these only work if the Control Plane is currently working.</td></tr><tr id=both-control-and-data-plane-down><th>Both Control and Data Plane Down</th><td>In this situation the <a href=https://docs.trustgrid.io/docs/nodes/>node</a> appears down in the Trustgrid Portal and users/applications are unable to reach services across the data plane between the Gateway and Edge sites. This is the most common scenario. While the Data Plane is most critical for the services provided across the device, first priority should be restoring the Control Plane connection so that additional troubleshooting tools are available. Often this process also uncovers the reason the data plane is down.</td></tr></div><div class=td-content style=page-break-before:always><h1 id=pg-ac421cd7a8e4dc3a9177045b633b3556>2.4 - Site Failover</h1><div class="pageinfo pageinfo-primary"><p>The below processes should be used to move traffic between sites in event of a complete site down scenario. This is handled by the Virtual Network Route Table.</p></div><div class="alert alert-primary" role=alert>In the examples below, xxxEdgeCluster is the primary site and xxx-edge3 is the secondary/disaster recovery site.</div><h3 id=manual-failover>Manual Failover</h3><p>When a customer has selected manual failover, a portal user will need to adjust the destination of all <a href=https://docs.trustgrid.io/docs/domain/virtual-networks/routes/>routes</a> currently pointed at the failed site.</p><h4 id=failing-over>Failing Over</h4><blockquote><p>There will usually be <a href=https://docs.trustgrid.io/docs/domain/virtual-networks/routes/>routes</a> for the <a href=https://docs.trustgrid.io/docs/nodes/>nodes&rsquo;</a> Virtual Management IP. These should not be changed in this process.</p></blockquote><ol><li><p>In the portal, navigate to <code>Domain</code> → <code>Virtual Networks</code> and then select the appropriate Virtual network.</p></li><li><p>Select the <code>Routes</code> panel from the left navigation bar.</p></li><li><p>Filter the route table either using the node/cluster names or network to be failed over (shown below).</p></li></ol><p><img src=route-table.png alt=img></p><pre><code>a. If there is more than one network that needs to be routed to the secondary site using node/cluster names to filter is more efficient
</code></pre><ol><li>Clear the destination field and start typing the name of the secondary site node/cluster. Select the appropriate node/cluster from the list.</li></ol><p><img src=destination-field.png alt=img></p><ol><li><p>Click <code>Save</code>. Then select <code>Review Changes</code>.</p></li><li><p>You should see a modified <a href=https://docs.trustgrid.io/docs/domain/virtual-networks/routes/>route</a> for each network you adjusted showing the previous and current destination. If everything looks correct click <code>Apply Changes</code>.</p></li></ol><p><img src=apply-changes.png alt=img></p><ol><li>It may take 1-2 minutes for nodes to pull down the updated routing table. Once that has completed any new flow or connection will automatically be sent to the new destination node.</li></ol><div class="alert alert-primary" role=alert>If the node/cluster is still online at the primary site, and there are existing flows/connections they will persist at that site. To clear them restart the active node at the primary site. See the last step in the Forcing Failover section below for instructions.</div><h4 id=failing-back>Failing Back</h4><p>To send traffic back to the primary site reverse the changes in the routing performed during the failover.</p><h3 id=automatic-failover>Automatic Failover</h3><p>When a customer has selected automatic failover between sites there should be no intervention required if the primary site goes offline. The route table will be configured with multiple routes with different metrics. When determining where to send virtual traffic a node will select:</p><ul><li>The most specific route - meaning if there is a route for 192.168.100.1/32 and another for 192.168.100.0/24, the /32 route will be preferred</li><li>With the lowest metric</li><li>that is currently available - meaning this node has an active tunnel to the destination node/cluster</li></ul><p>Below reflects a typical automatic failover configuration for a network</p><h4 id=forcing-failover-or-prevent-auto-failback>Forcing Failover or Prevent Auto-Failback</h4><p>If it is necessary to move traffic to the secondary site without the primary site going offline follow the below process.</p><p>Also, if a failure of the primary site has occurred and you want to ensure traffic does not automatically return to that site if it comes online (e.g. it is unstable) you can follow the same process.</p><ol><li><p>In the portal, navigate to <code>Domain</code> → <code>Virtual Networks</code> and then select the appropriate Virtual network.</p></li><li><p>Select <code>Routes</code> from the left navigation bar.</p></li><li><p>Filter the route table either using the node/cluster names or network to be failed over (shown below)</p></li></ol><p><img src=route-table.png alt=img></p><pre><code>a. If there is more than one network that needs to be routed to the secondary site using node/cluster names to filter is more efficient
</code></pre><ol><li>Adjust the metric so that the primary site is a higher number than the secondary site. The maximum metric value is 200.</li></ol><p><img src=metric.png alt=img></p><p>Click <code>Save</code> and navigate to <code>Review Changes</code></p><p>You should see a change like below for each route adjusted. Click <code>Apply Changes</code> if all looks correct.</p><p><img src=apply-changes-metric.png alt=img></p><ol><li><p>It may take 1-2 minutes for nodes to pull down the updated route table. At that point, they will route new flows/connections to the new destination.</p></li><li><p>Because the primary site is still online, you will need to restart the active node at that site to clear out any existing flows/connections.</p><p>a. If it&rsquo;s a cluster, navigate to the cluster and then select the currently active node from the overview page. If a single node site, navigate directly to that node.</p><p>b. From the toolbar select <code>Restart</code></p><p>c. Enter the node’s name and click <code>confirm</code></p></li></ol><h3 id=restore-traffic-to-primary-site>Restore Traffic to Primary Site</h3><p>To restore traffic to the primary site repeat the above steps but set the route for the primary site to have the lowest metric.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cd85acb6571e4c62ef3a6a45bd392e8b>3 - Changing the WAN Interface IP</h1><div class="pageinfo pageinfo-primary"><p>The WAN interface of a Trustgrid node is used to build connections to both the Control Plane and any Data Plane connectivity. Any change to this IP address is disruptive and presents a risk that the device will go offline if incorrect information is provided. This could potentially require a technical resource to go onsite to reconnect physical devices.</p></div><div class="alert alert-primary" role=alert>To make the below changes via the Trustgrid portal the user must have the Node Administrator or Administrator role.
The node must also be connected to the Trustgrid Control Plane to make this change via the portal.</div><p>The document details the process of updating the ETH0 - WAN Interface IP via the Trustgrid portal. This change can also be performed via the Trustgrid LocalUI .</p><h4 id=network-adapter-1---wan-ip-change----try-method>Network Adapter 1 - WAN IP Change - Try Method</h4><p><mark>Nodes must be running version 20200331 or newer to use the Try method</mark>
Trustgrid nodes have the ability to test a new IP configuration before permanently applying the configuration to the device. The process works like this:</p><ol><li><p>The user will enter the new IP configuration into the portal and click Try</p></li><li><p>The user will select the duration to try the new configuration (10, 30 or 60 minutes)</p><p>a. If the device successfully reconnects to the control plane after the select time the user will have the option of importing and saving this new configuration permanently, or reverting to the previous configuration.</p><p>b. If the device does not reconnect within the chosen duration, the device will automatically revert to its previous IP address configuration.</p></li></ol><p><mark>The device will revert to the original IP if it is rebooted or power cycled after initiating the “try” option and before importing and saving those changes in the portal.</mark></p><h4 id=changing-network-adapter-1---wan-via-try---detail-process>Changing Network Adapter 1 - WAN via Try - Detail Process</h4><ol><li><p>Login to the portal and navigate to the Node that you wish to reconfigure.</p></li><li><p>Confirm the node is actively connected to the cloud</p><blockquote><p>Note: If the device is not online when the below IP change is made it cannot pull this config from the device. Until it reconnects to the cloud it will continue using the original IP address.</p></blockquote><p>a. First confirm there is a green dot next to the node name</p><p><img src=tester.png alt=img></p><p>b. Confirm that you can open an interactive tool such as Terminal or Sniff Interface traffic. Leave this tool open so you know it when the device</p></li><li><p>Navigate to the Configuration > Network section and confirm Network Adapter 1 - WAN Interface is selected.</p></li></ol><p><img src=network-config.png alt=img></p><ol start=4><li>Set the IP settings to the desired new configuration</li></ol><p><img src=lotsa-servers.png alt=img></p><pre><code>a. Not that the IP adress and the subnet mask are to be entered in CIDR notation
</code></pre><ol start=5><li>SCroll down and select <code>Try</code></li></ol><p><img src=try.png alt=img></p><ol start=6><li>Select the duration of time the device should be allowed to be disconnected before reverting to the prior IP configuration and click <code>Confirm</code></li></ol><p><img src=apply-confirmation.png alt=img></p><ol start=7><li>The below warning will be presented for confirmation. You will need to type in the word &lsquo;yes&rsquo; to confirm.</li></ol><p><img src=type-yes.png alt=img></p><ol start=8><li><p>At this point the device will apply the new IP address and attempt to reconnect.</p><p>a. If the device cannot connect for the chosen duration the settings will revert to the original IP settings.</p><p>b. If the device successfully reconnects you will be presented with the below options. You may need to refresh the page to see these options.</p><p><img src=yellow-box.png alt=img></p><pre><code> i. Import - This option will update the portal to show the new IP address information.

 ii. Revert - This option will revert the portal to show the original IP address information.
</code></pre><p>c. Select the desired option and then scroll down and select <code>Save</code>. Again you will be prompted to confirm the change.</p></li></ol><h4 id=network-adapter-1---wan-ip-change---save-method>Network Adapter 1 - WAN IP Change - Save Method</h4><p>This process is very similar to the above with the exception that <mark><strong>the change is permanent</strong></mark>. The device will continue to use the configured IP address until either:</p><ul><li><p>The device connects to the cloud using the newly saved IP, at which point this process or the above Try method can be used to reconfigure the IP remotely</p></li><li><p>The device is reconfigured locally using either the Trustgrid Local UI or console (contact Trustgrid Support)</p></li></ul><h4 id=changing-network-adapter-1---wan-via-try---detail-process-1>Changing Network Adapter 1 - WAN via Try - Detail Process</h4><ol><li><p>Login to the portal and navigate to the Node that you wish to reconfigure.</p></li><li><p>Confirm the node is actively connected to the cloud</p></li></ol><blockquote><p>Note: If the device is not online when the below IP change is made it cannot pull this config from the device. Until it reconnects to the cloud it will continue using the original IP address.</p></blockquote><pre><code>a. First confirm there is a green dot next to the node name
</code></pre><p><img src=tester.png alt=img></p><pre><code>b. Confirm that you can open an interactive tool such as Terminal or Sniff Interface traffic.  Leave this tool open so you know it when the device
</code></pre><ol start=3><li>Navigate to <code>Configuration</code> -> <code>Network</code> section and confirm Network Adapter 1 - WAN Interface is selected.</li></ol><p><img src=network-config.png alt=img></p><ol start=4><li>Set the IP settings to the desired new configuration</li></ol><p><img src=lotsa-servers.png alt=img></p><pre><code>a. Note that the IP address and subnet mask are to be entered in CIDR notation.
</code></pre><ol start=5><li><p>After setting the IP address click Save</p></li><li><p>You’ll be presented with a warning like the below. Type &lsquo;yes&rsquo; and click <code>Confirm</code>.</p></li></ol><p><img src=type-yes.png alt=img></p><ol start=7><li><p>The device will be notified it has an updated configuration. It will pull this configuration down and automatically restart the Trustgrid service using the new IP address.</p><p>a. The restart usually takes less than a minute.</p><p>b. What ever interactive service you were using (Terminal, etc) should disconnect.</p></li><li><p>After the local site networking is updated (either physically by moving a cable, or logically by updating the connected switch port config) so that the new IP address can connect the device should come back online.</p></li></ol><h3 id=addition-post-ip-change-verification>Addition Post-IP Change Verification</h3><p>After the WAN IP has been changed there are a few areas where the WAN interface IP may have been used:</p><h4 id=gateway-nodes>Gateway Nodes</h4><p>If the Trustgrid node is acting as either a public or private gateway, you may also need to update the Public IP field under <code>System</code> -> <code>Gateway</code> -> <code>Server Settings</code>. If your gateway is using DNS instead you will need to update that DNS record accordingly.</p><p><img src=private-server.png alt=img></p><h3 id=clustered-nodes>Clustered Nodes</h3><p>If the Trustgrid node is clustered and the WAN interface IP was being used for the cluster heartbeat you will need to adjust the IP address it is listening.</p><p>The heartbeat IP and port is visible under <code>System</code> -> <code>Cluster</code> of each cluster member’s node detail page.</p><p><img src=cluster-system.png alt=img></p><p>If the Host field is using the old WAN interface IP address, change it to the new IP and click <code>Save</code>.</p><p><img src=cluster-comms.png alt=img></p><blockquote><p>If the nodes has two or more interfaces, it is typical that those LAN interface IPs will be used for the cluster heartbeat. In that case no change is required on this page.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-6cf6f9d5da8c1aec9f1d6c776bfadad2>4 - Configure FTP and FTPS</h1><h2 id=ftps--ftps-using-layer-3>FTPS & FTPS Using Layer 3</h2><p>FTP & FTPS are supported in passive mode when using layer 3. This configuration requires the FTP server to be configured with the external IP address in the passive settings set to the Trustgrid virtual IP that corresponds to the FTP server.</p><p>FileZilla passive mode settings:</p><p><img src=filezilla.png alt=img></p><h2 id=ftp-using-layer-4>FTP Using Layer 4</h2><p>FTP is supported in passive mode when using L4 Proxy, however FTPS is not. To configure FTP access through L4 Proxy, the Outbound L4 Service and/or L4 Connector need to be configured with FTP set as the protocol as shown below:</p><p><img src=ftp-service.png alt=img></p><p><img src=ftp-connector.png alt=img></p></div><div class=td-content style=page-break-before:always><h1 id=pg-3a987d5d26cd7dfc26cf2a8db95ac3a7>5 - Configure Layer 3 VPN</h1><p>The VPN feature enables routing of IP packets by utilizing a virtual IP space that is configured on the nodes. In this configuration, the node can be used as the next hop for route destined for the virtual IP space, or the node can be used as the default gateway for a network. The virtual IP space is used as a transit network with NAT being utilized to translate IP addresses on to/from the virtual IP space on either side. It is also possible to preserve the original source and destination by having the virtual IP space be identical to the LAN network.</p><p>The Trustgrid VPN feature provides the capability to securely route IP packets between remote networks. In this configuration, Trustgrid nodes can operate as a distributed mesh virtual private network (VPN) that can allow applications to access remote data and services at layer 3 (L3) of the network OSI model. This is done by defining a virtual L3 network (similar to an Amazon VPC) and then selecting how local node networks are exposed and translated into the the virtual address space.</p><p>The following steps illustrate how to configure the Trustgrid VPN feature and will need to be configured on all <a href=https://docs.trustgrid.io/docs/nodes/>nodes</a>/<a href=https://docs.trustgrid.io/docs/clusters/>clusters</a> that need to communicate across the virtual network.</p><ol><li>Create the Virtual Network
Under <code>Domains</code> -> <code>Domain</code> -> <code>Virtual Networks</code> create the <code>Virtual Network</code>. All gateway/edge nodes deployed and attached to this virtual network will need to be assigned a subnet out of this IP space. It is important to ensure the CIDR created is large enough to encompass all future node deployments. In this example the entire IPV4 space is being used. This IP space is only applicable to the individual virtual network therefore if there are multiple virtual networks there is no overlap or conflict in IP space allocation.</li></ol><p><img src=create-vn.png alt=img></p><ol start=2><li>Create <a href=https://docs.trustgrid.io/docs/domain/virtual-networks/routes/>Routes</a> for the desired Virtual CIDR with the destination being either a single node or a cluster if an HA deployment.</li></ol><p><img src=create-vn2.png alt=img></p><ol start=3><li>Create the appropriate ACL’s if desired for only allowing specific traffic to pass. An ACL is required for any traffic to pass as it is a zero trust model. If traffic is already filtered before reaching the Trustgrid nodes then at minimum an <code>Any:Any</code> rule will need to be created as seen below.</li></ol><p><img src=create-vn3.png alt=img></p><ol start=4><li>Attach Virtual Network to Node / Cluster
Select the node or cluster and under vpn attach the virtual network. Define the validation CIDR which should match the route created. NAT rules can only be created within this CIDR.</li></ol><p><img src=detach2.png alt=img></p><ol start=5><li>Select the appropriate interface to attach the virtual network to. This can be a physical interface or a virtual vlan interface and should be whichever interface clients will be using as the next hop to reach the remote networks. Configure the appropriate Inside and Outside NATs and then save the configuration. NATs explained in further detail below.</li></ol><p><img src=remove.png alt=img></p><h4 id=inside-nat>Inside NAT:</h4><p>An inside NAT defines how a local device IP address translates into a virtual network address. For instance, a local device may have a local IP address of 192.168.1.100, but you may want it to appear to other devices or applications on the virtual network as IP address 10.0.20.100. Or you may want an entire block of local IP addresses to show up on the virtual network as a different block. You can do this translation via Inside NATs. Inside NAT&rsquo;s also control what local devices can participate on the virtual network. If a local device does not have an inside NAT configured that includes its IP address, it can&rsquo;t access or be accessed by other devices on the network. To add an inside NAT you must enter the following information:</p><ol><li><p>Local CIDR - The local IP address or address block that should be mapped into the virtual network. It should be entered in CIDR block format (eg - 192.168.100.0/24 or 192.168.100.51/32).</p></li><li><p>Virtual CIDR - The network IP address or addresses that the local IP addresses should be mapped to, also entered in CIDR block format.</p></li></ol><p>Note that network addresses map 1x1 with local addresses, so the prefix length (the /xx number of the CIDR) should be the same in both the local and network CIDR blocks of the inside NAT entry.</p><h4 id=outside-nat>Outside NAT:</h4><p>By default, when a device on the local network of a node receives traffic from a remote device on the network, the remote device IP address will be the IP address that was entered in the local CIDR block for the remote node&rsquo;s inside NAT entry for the remote device. For instance, if the remote device was mapped to network address 10.0.100.1, then its traffic on the local network will appear to come from IP address 10.0.100.1. However due to the local network configuration, there may be some situations where it is desirable to translate remote network addresses before egressing onto the local network. For instance on a local network of 192.168.0.0/16, a user may want the remote devices virtual network IP of 10.0.100.1 to be translated to 192.168.50.5 so that it fits better into the local network setup. This kind of translation can be achieved by adding outside nats. To add an outside NAT you must enter the following information:</p><ol><li><p>Network Group - The network IP address or addresses that should be translated before egressing onto the local network. This should be entered in CIDR block format.</p></li><li><p>Local CIDR - The local IP address or addresses that the network addresses should be mapped to, also entered in CIDR format.</p></li></ol><p>Note there are situations where it may be desirable to make multiple remote devices masquerade as one local IP address though the use of port address translation (PAT). This can be achieved by defining an outside nat in which the network CIDR contains a larger address space than the local CIDR. For instance, an entry with network CIDR 10.0.1.0/24 and local CIDR 192.168.100.10 would make all remote devices with network IP addresses in 10.0.1.0/24 appear as IP address 192.168.100.10 on the local network.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-61c9a49ae9f7259a162c4399588119f6>6 - Configure WireGuard on an Edge Node</h1><p>This describes the process of deploying a WireGuard client which will act as a Trustgrid Edge node connecting to a Trustgrid gateway routing traffic for clients connecting via the WireGuard service. This process describes how to configure it using an Ubuntu Linux server.</p><ol><li><p>Deploy Wireguard Service: <a href=https://linuxize.com/post/how-to-set-up-wireguard-vpn-on-ubuntu-18-04/>https://linuxize.com/post/how-to-set-up-wireguard-vpn-on-ubuntu-18-04/</a></p><p>Below is an example wireguard interface config for wg0. Per the above article, iptables rules need to be added to source nat the traffic to the wireguard interface address from all clients.</p><pre tabindex=0><code>[Interface]
PrivateKey = QPuBCrqefTzPkF+QIMjADFOoWSI+4xFc33M697btnQ=
Address = 172.16.22.10/24
DNS = 8.8.8.8, 4.2.2.2
[Peer]
PublicKey = f85A1r4j3WWANBCTEIGNWLDMoqyepJWUmaDC4yVY=
PresharedKey = K9g6ZZ/IXeZL1ACAUEVB2hgFir2AAfhBRaRWVhcJyA=
AllowedIPs = 192.168.20.0/24
Endpoint = 172.16.22.20:5555
PersistentKeepalive = 30
</code></pre><p>IPTables rules:</p><pre tabindex=0><code>sysctl -w net.ipv4.ip_forward=1
iptables -A FORWARD -i wg0 -j ACCEPT
iptables -t nat -A POSTROUTING -o wg0 -j MASQUERADE
iptables -t nat -A POSTROUTING -o ens192 -j MASQUERADE
</code></pre></li><li><p>Enable the Wireguard Service on the Trustgrid Gateway and define the desired port. Also either generate or import the public key to be used</p><p><img src=gen-key.png alt=img></p></li><li><p>Configure the wireguard service as a client of the Trustgrid Gateway. If the gateway is a member of a cluster it will be configured under the cluster configuration options otherwise it will be configured on the individual gateway. Enter in the desired client name / the pre-shared key and public key generated on the wireguard server. Internet access can also be allowed if that is being configured on the gateway side.</p><p><img src=add-client.png alt=img></p></li><li><p>Select the client that was added and configure the inside nat. The virtual CIDR should be within the virtual network space that the Gateway is attached to as seen below. This can be seen under domains > domain > virtual networks. The Local CIDR should be the wireguard interface address that is sourcing all traffic to the gateway. An outside NAT is not normally required.
<img src=nats.png alt=img>
<img src=vnet.png alt=img></p></li><li><p>Any hosts communicating with the remote networks on the gateway side will need to use the wireguard server interface as the next hop for reaching that network.</p></li></ol><p><em>&ldquo;WireGuard&rdquo; is a registered trademark of Jason A. Donenfeld.</em></p></div><div class=td-content style=page-break-before:always><h1 id=pg-e552eb1d84853a74b1be90527c1b7213>7 - Deployments</h1></div><div class=td-content><h1 id=pg-b4372d0404394d7880ccab62b7398289>7.1 - AWS Requirements for HA Wireguard Cluster</h1><ol><li>Create EC2 Target Group and add both Trustgrid gateways with the target being wireguard server port (Default UDP 51820)</li></ol><p>The health check should be set to http with a path of /status and override traffic port to be port 80.</p><p>Only the active member of the Trustgrid Cluster will respond as healthy to the health check.</p><p><img src=wg-ha.png alt=img></p><p><img src=health-checks.png alt=img></p><ol start=2><li>Create NLB (Network Load Balancer) with listener set to configured UDP wireguard server port (Default 51820) and forwarding to the target group created above. The load balancer should be created as internet facing IPV4 and mapped to the Public facing subnets of the Trustgrid gateways.</li></ol><p><img src=edit-listener.png alt=img></p></div><div class=td-content style=page-break-before:always><h1 id=pg-babdda31d36538ba18809318bb6e3d66>7.2 - AWS Requirements for HA ZTNA Gateway Cluster</h1><ol><li>Create EC2 target group and add both Trustgrid application gateways with the target being TCP port 80.</li></ol><p>The health check should be for http and the path should be <code>/status</code></p><p>Only the active member of the Trustgrid Cluster will respond as healthy to this check.</p><p><img src=nate-test.png alt=img></p><ol start=2><li>Create an ALB (Application Load Balancer) with the listener set to HTTPS and forwarding to the target group created above. Under secure listener settings apply the SSL Certificate provided by Trustgrid for the application gateways. <code>ELBSecurityPolicy-2016-08</code> is recommended as the default security policy by AWS.</li></ol><p>The load balancer should be created as internet facing IPV4 and mapped to the Public facing subnets of the Trustgrid gateways.</p><p><img src=listener-details.png alt=img></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ecf5e347f65f7bfb202ac608a2e20f2d>7.3 - Configure HA Trustgrid Gateway Cluster in AWS</h1><ol><li><p>Deploy a pair of Trustgrid gateways. Deployment guide includes an example Cloud Formation template that can be used directly or customized for your environment or converted to Terraform if preferred. Gateways can be deployed in the same availability zone or different ones to provide greater redundancy across AWS. <a href=https://docs.trustgrid.io/tutorials/deployments/deploy-aws-ami/>Deploy a Trustgrid Node AMI in AWS</a>.</p></li><li><p>Under networking > clusters create a cluster using a descriptive and unique name as seen below.
<img src=add-cluster.png alt=img></p></li><li><p>Select the cluster that was created and add both gateways to it using the actions drop down button as seen below.
<img src=add-node.png alt=img></p></li><li><p>Configure the cluster heartbeat on each individual gateway node. This is located under system > cluster. The host should be the gateway interface on which you want to configure the heartbeat. This can be either the WAN facing or LAN facing interface. You can see what IP is configured from the node page under interfaces. The port defaults to TCP 9000 but can be any unused TCP port if desired. Security groups for both gateways will need to allow this communication in both directions. Both gateways send a heartbeat to each other on the configured IP and Port to determine if the other member is healthy. If the secondary is not able to get a response from the primary then it will become the active member of the cluster. Once this has been configured both nodes should show as green and healthy in the cluster as seen below.
<img src=cluster-status.png alt=img>
<img src=nodes-list.png alt=img></p><div class="alert alert-primary" role=alert>If deploying gateways in different availability zones then LAN interface routes will need to be added to the cluster for both gateway LAN subnets as seen below. This is to ensure the heartbeat communication is routed over the correct interface instead of going out the WAN interface.</div><p><img src=interfaces.png alt=img></p></li><li><p>Under the cluster > interfaces > eth1 LAN > AWS Route Table Entries add the appropriate CIDR for the edge IP space. This should be the subnet that includes all virtual network IP space configured for edge node sites. For example if you have 100 different edge node sites carved out of 172.16.0.0/16 then you would just add this one CIDR. Once this has been added the route should be created in the routing table that is associated to the gateways LAN interface pointing to the ENI of the active member of the cluster.</p><p>There is an IAM profile that should have been associated to each gateway outlined in the deployment guide providing them permissions to manage the routes defined in the AWS Route Table Entries. When a failover event occurs an API Call is made to update the route to point to the ENI of the active member of the cluster.</p><p>This concludes the cluster configuration specifics for AWS deployment. Appropriate VPN configuration will need to be applied in order for traffic to pass end to end between the gateways and edge node sites.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-ced9fd24d3e032d3def2aca0be2e6355>7.4 - Deploy a Trustgrid Node AMI in AWS</h1><p>Standing up a Trustgrid node in AWS is easy using an Amazon AMI. Trustgrid nodes in AWS use two network interfaces - a management and data interface. The management interface communicates with Trustgrid Cloud Management systems. The data interface is used to terminate TLS tunnels from Edge Nodes.</p><h2 id=notes>Notes</h2><ul><li>The cloudformation template below works with an AMI currently published in US-EAST1. Deploying in other regions requires working with Trustgrid Support</li><li>Logs /var/log/syslog, /var/log/secure, and /var/log/trustgrid/tg-default.log to CloudWatch</li><li>Requires VPC and public subnet</li><li>Does not create security groups or roles - those have to be managed separately (more below)</li></ul><div class="alert alert-primary" role=alert><p>If using a burstable performance instance types (T2, T3 and T3a) the following is advised:</p><ul><li><p>Set CPU Credits for all Gateway instances to unlimited to allow CPU to burst in the event there is a spike above the normal threshold. <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/burstable-performance-instances-unlimited-mode.html>Unlimited mode for burstable performance instances - Amazon Elastic Compute Cloud</a></p></li><li><p>Configure monitoring of your CPU Credit Balance to alert if your credits are being consumed or you are being charged for additional CPU usage which might warrant resizing your devices. <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/burstable-performance-instances-monitoring-cpu-credits.html>Monitor your CPU credits - Amazon Elastic Compute Cloud</a></p></li></ul></div><h2 id=prerequisites>Prerequisites</h2><ul><li><p>VPC with public and private subnets - Management NIC goes in the public subnet, Data NIC goes in the private subnet</p><ul><li>Note: If doing a multi-AZ cluster deployment the private subnets need to use the same route table for automated route management to work</li></ul></li><li><p>Security group for management NIC that allows the following traffic:</p><ul><li>Inbound traffic on designated Trustgrid gateway port (typical TCP 8443) for remote nodes. Access to this port can be secured to only allow access from remote nodes if desired. This is only required if deploying a Trustgrid gateway. If the node is acting as an edge then no inbound access is required.</li><li>Outbound traffic to Trustgrid’s control plane IP (TCP 80/443 & 8443 to 35.171.100.16/28 & 34.223.12.192/28)</li><li>Outbound traffic to AWS API (TCP 443) <a href=https://docs.aws.amazon.com/general/latest/gr/aws-ip-ranges.html>https://docs.aws.amazon.com/general/latest/gr/aws-ip-ranges.html</a></li><li>Inbound & Outbound to/from management NIC security group on cluster port (typically TCP port 9000)</li><li>For the initial deployment outbound access for TCP 80/443 should be allowed. Upon successful registration with the Trustgrid Portal this can be removed.</li></ul></li><li><p>IAM role for the instance with policies allowing publishing to Cloudwatch logs and changes to the routing table of the data NIC - See attached doc</p></li><li><p>All Interfaces on the Trustgrid Gateway should have source / destination check disabled in AWS</p></li><li><p>Security group for data NIC - No configuration for now</p></li><li><p>An IP in the private subnet that will be used by the data NIC</p></li><li><p>An SSH keypair that can be used to SSH to the instance if necessary</p></li><li><p>VPC must have unallocated public IP that will be claimed during provisioning</p></li></ul><h2 id=process>Process</h2><ol><li><p>Create a new Node. When complete the Node license will copy to clipboard.</p><ul><li>Note: The node will not be visible in the portal until the registration process is complete.</li><li>Download the license to local storage in case the clipboard is cleared. You cannot reissue a license without recreating the node.</li></ul></li><li><p>Click this link to start the AMI provisioning process. <a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/tg-dev-public/cf-trustgrid-node.json">https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/tg-dev-public/cf-trustgrid-node.json</a></p></li><li><p>Fill out the fields in the CloudFormation form</p></li></ol><h2 id=instance-configuration>Instance Configuration</h2><tr id=stack-name><th>Stack Name</th><td>Unique name to describe this deployment</td></tr><tr id=instance-type><th>Instance Type</th><td>Set the instance type of the EC2 instance to deploy (bigger instances cost more)</td></tr><tr id=host-iam-role><th>Host IAM Role</th><td><p>An EC2 associated role that allows creating and writing to CloudWatch logs. Only the role name itself is required.</p><p>The role needs these IAM privileges: <code>logs:CreateLogGroup</code>, <code>logs:CreateLogStream</code>, <code>logs:PutLogEvents</code>, <code>logs:DescribeLogStreams</code> on resource <code>arn:aws:logs:*:*:*</code></p><p>Cloudwatch logs policy</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;Version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;2012-10-17&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;Statement&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;Effect&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Allow&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;Action&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;logs:CreateLogGroup&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;logs:CreateLogStream&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;logs:PutLogEvents&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;Resource&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If EC2 Nodes will be clustered (Layer 3) the IAM role needs <code>ec2:DescribeRouteTables</code> for any resource and <code>ec2:CreateRoute</code> & <code>ec2:DeleteRoute</code> on the route table</p><p>Route Table Policy</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&#34;Effect&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Allow&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&#34;Action&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ec2:DescribeRouteTables&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&#34;Resource&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;*&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>,</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&#34;Effect&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Allow&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&#34;Action&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>		<span style=color:#4e9a06>&#34;ec2:CreateRoute&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>		<span style=color:#4e9a06>&#34;ec2:DeleteRoute&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&#34;Resource&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;arn:aws:ec2:us-east-1:079972220921:route-table/rtb-f428d58b&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>NOTE</strong>: Set the Resource field to the ARN of the Routing Table associated with the data NICs of the instance.</p><p><strong>CloudWatch Note</strong>: We will create log groups named /trustgrid/var/log/syslog and /trustgrid/var/log/trustgrid/tg-default.log.</p></td></tr><tr id=ssh-keypair><th>SSH Keypair</th><td><p>SSH keypair to SSH to the instance as ubuntu user if necessary</p><p><strong>NOTE</strong>: SSH access requires a security group change allowing access. We strongly recommend that SSH is not allowed from anywhere (0.0.0.0/0).</p></td></tr><h2 id=management-configuration>Management Configuration</h2><tr id=security-group><th>Security Group</th><td>Needs to allow outbound traffic to other gateways and our public IP range, at a minimum. If it&rsquo;s a gateway node, needs to allow inbound access on desired gateway port.</td></tr><tr id=subnet><th>Subnet</th><td>The VPC subnet to put the EC2 instance in. This needs to be a subnet with public IP enables (the instance will automatically claim one; the Auto-Assign Public IP does not need to be enabled)</td></tr><h2 id=data-path-configuration>Data Path Configuration</h2><tr id=security-group><th>Security Group</th><td>The security group for the data path - needs to allow outbound communication to other gateways, and inbound communication on its gateway port</td></tr><tr id=subnet><th>Subnet</th><td>The VPC subnet to put the data interface in - if it&rsquo;s a cloud-accessible gateway, should be a public subnet, if it&rsquo;s only for internal AWS traffic, can be a private subnet. Will need outbound access either through IGW or NAT GW.</td></tr><tr id=data-ip><th>Data IP</th><td>The private IP for the data path - must belong to the subnet</td></tr><h2 id=trustgrid-configuration>Trustgrid Configuration</h2><tr id=security-group><th>Security Group</th><td><p>Copy/paste the license from the portal.</p><p>Note: It is critical that you copy/paste the license correctly.</p></td></tr><div class="alert alert-primary" role=alert>If you are not a direct Trustgrid customer please work with your vendor to get these licenses generated and sent to you.</div><h2 id=creating-the-stack>Creating the Stack</h2><ol><li>Create the stack. Check the box acknowleding that AWS CloudFormation might create IAM resources. This is required because we create an instance profile for the to-be-run EC2 instance.</li><li>When the node appears in the Portal, activate it.</li><li>In the EC2 console, reboot the node (it will be named trustgrid-node)</li><li>You can now manage the node as you would any other in the Portal UI.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-f9b4bb0bebfa94e31f6dfbaf1cde6df3>7.5 - Deploy to Azure</h1><h2 id=vm-requirements>VM Requirements</h2><table><thead><tr><th>Requirement</th><th>Description</th></tr></thead><tbody><tr><td>OS</td><td>Ubuntu 18.04 LTS</td></tr><tr><td>Disk Size</td><td>At least 30 GB</td></tr></tbody></table><h3 id=instance-type>Instance Type</h3><p>Trustgrid has validated using the <a href=https://learn.microsoft.com/en-us/azure/virtual-machines/sizes-b-series-burstable>B-series burstable - Azure Virtual Machines</a> instance type.</p><p>VPN throughput is tied to CPU the recommended size depends on roles, expected throughput.</p><ul><li>For Gateway nodes expecting up to ~200Mbps throughput, Trustgrid recommends the Standard_B4ms or larger</li><li>For Edge nodes expecting less than 100Mbps throughput, Trustgrid recommends the Standard_B2s or Standard_B2ms or larger</li></ul><h3 id=interfaces>Interfaces</h3><p>One WAN interface with a public IP and one LAN interface on a private subnet. The nodes will need to be able to route to all required hosts/applications that need to communicate across the Trustgrid virtual network.</p><p>The LAN interface needs to have <strong>IP Forwarding Enabled</strong> in order to forward the traffic across the tunnel.</p><p><img src=azure-ip-config.png alt="IP Forwarding"></p><p>See <a href=https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview>Azure virtual network traffic routing</a>.</p><h3 id=network-access>Network Access</h3><blockquote><p>During deployment only, Trustgrid will need direct SSH access from their provisioning system to the VM instances that will be converted into Trustgrid nodes.</p></blockquote><p>For gateways:</p><ul><li>Outbound internet access to the <a href=https://docs.trustgrid.io/help-center/kb/site-requirements/>Trustgrid control plane networks</a> and ability to resolve public DNS names.</li><li>Inbound access required is the TCP port defined for the Trustgrid gateway service to listen on. Edge nodes will connect to the gateways public IP and port defined. The default port used is 8443.</li></ul><p>For edge nodes:</p><ul><li>Outbound internet access to the <a href=https://docs.trustgrid.io/help-center/kb/site-requirements/>Trustgrid control plane networks</a>, outbound access to the IP and ports of the Trustgrid gateways, and ability to resolve public DNS names.</li><li>No inbound access is required on the public interface.</li></ul><p>For all clustered nodes:</p><ul><li>The cluster heartbeat runs on the LAN/inside interface on TCP Port 9000. This port will need to be open between both Trustgrid Gateways for failover to work correctly.</li></ul><h3 id=admin-username-and-ssh-key>Admin Username and SSH Key</h3><p>Trustgrid requires SSH access to the deployed VM to complete the Trustgrid deployment process. After the deployment is complete the VM ceases to listen on port 22 and any external access to that port can be revoked.</p><ul><li><p>Username: <code>ubuntu</code></p></li><li><p>SSH public key:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDK1AHNLfqOd13qsWQGa4FgoNcpllJYlIlkJdqCkLFq0qaYVrh0b1mxalVzrrxy8rSj7DYlofRArb9hntijLnkrlKxMcWVgqMg4JAcXEQvWUtkIwFemE/NoZoXncKfr6lJZ/+gT1LhNX7IMUh7vVhYsyhDkbdvU0FcnJVelEW5TCRdPLzTMcbRfjCo6MiCoMK45nQIKRHofAJFPSubmPAKZC0L1Dz4zwnb1PeCadSDRHDwPWB3vCl9H/h+7Oe7TC+kEc4bV8OzZTnzfX4Mdo9rb9Afz3ZFWYYh3KP2v1hsF6rtSLS6EpuMZVS41YHvGpHQjFgn0n8hNIoQvf9gO4hxH</span></span></code></pre></div></li></ul><h2 id=requirements-for-ha-failover>Requirements for HA Failover</h2><h3 id=azure-routing-table>Azure Routing Table</h3><p>An Azure routing table resource needs to be associated with the LAN interface&rsquo;s subnet.</p><h4 id=view-lan-subnet-routing-table>View LAN Subnet Routing Table</h4><ol><li><p>In the Azure Portal search for Virtual Networks and select the service</p></li><li><p>From the list of Virtual Networks select your target Virtual Network</p></li><li><p>From the navigation panel select Subnets</p></li><li><p>Select your inside/private subnet that is attached to the LAN interface of your Trustgrid VMs</p></li><li><p>There should be a route table</p><p><img src=azure-route-table.png alt="Route Table"></p></li></ol><h4 id=create-route-table-for-lan-subnet>Create Route Table for LAN Subnet</h4><ol><li><p>If there is no Route Table associated with your LAN/inside/private subnet you will need to add it.</p></li><li><p>In the Azure portal search for Route Tables and select the service</p></li><li><p>Click the +Create button</p></li><li><p>Select the Resource Group that contains your Virtual Network and VMs</p></li><li><p>Select the Region that your VMs are deployed in</p></li><li><p>Give the Route Table a name consistent with your naming conventions</p></li><li><p>(Optional) change the Propagate Gateway routes option.</p><p><img src=propagate-routes.png alt="Propagate Routes Option"></p></li><li><p>Click Review + Create, review then click Review + Create again</p></li><li><p>Repeat the above steps to “View LAN Subnet Routing Table” and change the route table from None to the newly created Route Table.</p></li><li><p>Save the change</p></li></ol><h3 id=permissions-required-for-cluster-route-failover>Permissions Required for Cluster Route Failover</h3><p>Copy this sample json file for use in creating a custom role with the required permissions. See process below.</p><blockquote><p>The assignableScopes section will need to be modified to represent the resource information of the target Azure account.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>&#34;properties&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&#34;roleName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;tg-route-table&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&#34;description&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;manage azure route table&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&#34;assignableScopes&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>&#34;permissions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>			<span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&#34;actions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Network/networkWatchers/nextHop/action&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Network/networkInterfaces/effectiveRouteTable/action&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Network/routeTables/routes/delete&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Network/routeTables/routes/write&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Network/routeTables/routes/read&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Network/routeTables/join/action&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Network/routeTables/delete&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Network/routeTables/write&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Network/routeTables/read&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Network/networkInterfaces/read&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Network/virtualNetworks/read&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>					<span style=color:#4e9a06>&#34;Microsoft.Compute/virtualMachines/read&#34;</span>
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&#34;notActions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[],</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&#34;dataActions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[],</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>&#34;notDataActions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[]</span>
</span></span><span style=display:flex><span>			<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span></span></span></code></pre></div><ol><li><p><a href=https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm>System-assigned Managed Identity</a> needs to be enabled for both VMs in the cluster.</p><p><img src=system-managed-identity.png alt="System-assigned Managed Identity"></p></li><li><p>A custom role needs to be created in the Azure subscription that allows the Trustgrid nodes to update the route table when failover occurs</p><ol><li>Create the custom role<ol><li><p>In the Azure portal search for “Subscriptions” and select the Subscriptions service</p></li><li><p>Select the subscription that contains the Trustgrid VMs</p></li><li><p>Select “Access control (IAM),” then click “+Add”, then “Add custom role”</p><p><img src=add-custom-role.png alt="Add Custom Role"></p></li><li><p>Save the JSON above to a file named <code>azure-custom-role-sample.json</code>.</p></li><li><p>Select “Start from JSON” and from the file selector, select the downloaded json file.</p><p><img src=create-custom-role.png alt="Create Custom Role"></p></li><li><p>Optionally, update the role name to meet your internal naming conventions.</p></li><li><p>Click <code>Next</code>.</p></li><li><p>On the Permissions page you will see the permissions that will be granted. Click <code>Next</code> again.</p></li><li><p>On the Assignable Scopes page click +Add Assignable Scope</p><ol><li><p>From the Type select Resource Group</p></li><li><p>From the Subscription, select the subscription your VMs and virtual networks are in.</p></li><li><p>From the Select pane on the right search for and select the Resource Group containing you VM’s</p><p><img src=select-group.png alt="Resource Group"></p></li><li><p>Click <code>Select</code> and then <code>Next</code>.</p></li></ol></li><li><p>On the JSON page, click the <code>Next</code> button.</p></li><li><p>Click Review + Create, then click Create.</p></li></ol></li></ol></li><li><p>Assign the custom role to your Trustgrid VM’s system-assigned</p><ol><li><p>In the Azure portal search for Resource Groups and select the service</p></li><li><p>Select your target Resource Group</p></li><li><p>Select the Access Control (IAM) panel, then click +Add, then “Add role assignment”</p><p><img src=add-role.png alt="Add Role Assignment"></p></li><li><p>Search for and select the desired role and click Next</p><p><img src=role-list.png alt="Find Role"></p></li><li><p>Under “Assign access to” select “Managed Identity” then click +Select members</p><p><img src=select-members.png alt="Select Members"></p></li><li><p>From the Managed Identity dropdown select Virtual Machine</p></li><li><p>Select the identity for your first Trustgrid VM</p><p><img src=subscriptions.png alt=Subscription></p></li><li><p>Click select.</p></li><li><p>Click +Select members again and repeat with your second Trustgrid VM</p></li><li><p>Click “Review + Assign” then “Review + Assign” a second time</p></li></ol></li></ol><blockquote><p>These permissions can take some time to go into effect.</p></blockquote><h2 id=deployment-process>Deployment Process</h2><p>The current deployment process involves Trustgrid and the site’s technical team with Azure access working together to complete converting a standard Ubuntu 18.04 LTS based VM into a Trustgrid Appliance (or appliances for a clustered deployment).</p><h3 id=participants>Participants</h3><ul><li>Site Tech - User(s) with permissions to deploy new instances in Azure, create the required Managed System Identity shown above, and make changes to allow the required network connectivity</li><li>Trustgrid Tech - Trustgrid professional services team member that will complete the conversion of the generic image into a</li></ul><blockquote><p>If the Site Tech is not part of the organization that is Trustgrid&rsquo;s direct customer, Trustgrid will need documented approval from that customer before proceeding with assisting in the deployment.</p></blockquote><h3 id=high-level-process>High-Level Process</h3><ol><li>Prior to a scheduled call the Site Tech can:<ol><li>Build a vNet with public and private subnets if it does not already exist</li><li>Create the Managed System Identify permissions as defined above</li><li>Create VM Instances based of the Ubuntu 18.04 LTS image and sizing requirement mentioned above</li></ol></li><li>A conference call will be scheduled between the Site Tech and Trustgrid Tech during business hours</li><li>During the conference call:<ol><li>Trustgrid Tech -<ol><li>Confirm connectivity to the node</li><li>Run automation process to convert into Trustgrid appliance</li><li>Register the device with the target organization</li><li>Confirm healthy functionality and connectivity to the required</li><li>Configure and test clustering including route failover (if clustering is to be used)</li><li>Configure VPN (if to be used) and confirm access to required networks/hosts if possible</li></ol></li><li>Site Tech -<ol><li>Revoke direct SSH access</li></ol></li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-ef9aa21319b8de0c7d36e66cb0663a67>7.6 - Deploy to vSphere</h1><h2 id=requirements>Requirements</h2><h3 id=hardware-resources>Hardware Resources</h3><ul><li>4 vCPU</li><li>4 GB RAM</li><li>30 GB disk space</li></ul><h3 id=software-requirements>Software Requirements</h3><ul><li>vSphere 6.7 or newer (with VMWare support)</li></ul><h2 id=configuration-best-practices>Configuration Best Practices</h2><h3 id=backups>Backups</h3><p>Trustgrid recommends against backing up virtualized Nodes. Backups that utilize VMware&rsquo;s Data Protection API will initiate a VM Snapshot that will pause all traffic through the VM for a short period of time. This can cause issues such as master failover in a cluster and disruption of existing network flows.</p><p>In place of backups Trustgrid recommends deploying clustered nodes on different ESX hosts if possible. Nodes can be redeployed and rapidly configured as the configuration is stored in our cloud management system.</p><h3 id=dynamic-resource-scheduling-drs-and-storage-drs>Dynamic Resource Scheduling (DRS) and Storage DRS</h3><h4 id=automation-level>Automation Level</h4><p>Trustgrid recommends setting the DRS level for a VM to either Partially Automated or Disabled. Even the temporary loss of network connectivity during vMotion migrations can disrupt some network flows.</p><ul><li><a href=https://docs.vmware.com/en/VMware-vSphere/6.5/com.vmware.vsphere.resmgmt.doc/GUID-C21C0609-923B-46FB-920C-887F00DBCAB9.html>Set a Custom Automation Level for a Virtual Machine</a></li><li><a href=https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.resmgmt.doc/GUID-B560341B-B377-4FA7-BF3B-98A4788AAE3A.html>Change Storage DRS Automation Level for a Virtual Machine</a></li></ul><h4 id=recommended-anti-affinity>(Recommended) Anti-Affinity</h4><p>If you have Trustgrid nodes clustered within a vSphere Cluster with DRS enabled you should create an anti-affinity rule. This rule should keep the nodes running on independent hosts for additional hardware redundancy.</p><ul><li><a href=https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.resmgmt.doc/GUID-FBE46165-065C-48C2-B775-7ADA87FF9A20.html#GUID-FBE46165-065C-48C2-B775-7ADA87FF9A20>Create VM Anti-Affinity Rules</a></li></ul><h2 id=deployment-process>Deployment Process</h2><p>The Trustgrid gateway node can be deployed in a vSphere environment (v6.7 and higher) using a custom VM template provided by Trustgrid. Follow the instructions below to deploy the OVF template in your environment.</p><ol><li><p>Download & Extract the customized VM template from the link sent to you by Trustgrid</p></li><li><p>Open & log in to your vSphere web client</p></li><li><p>Navigate to Host & Clusters</p></li><li><p>Right click on vSphere ESX host in the Navigator pane and select Deploy OVF Template</p><p><img src=deploy-ovf-template.png alt=img></p></li><li><p>Select Local File and then click Browse</p><p><img src=browse-local-file.png alt=img></p></li><li><p>Select all of the files included in the zip file and click open, then click Next</p></li><li><p>Confirm the name and desired location for your VM and click Next</p><p><img src=name-vm.png alt=img></p></li><li><p>Select a resource to place your VM on and click Next</p><p><img src=select-resource.png alt=img></p></li><li><p>Click Next on the Review Details pane</p><p><img src=review-details.png alt=img></p></li><li><p>Select your preferred storage options and click Next</p><p><img src=select-storage.png alt=img></p></li><li><p>Select the proper networks for your network interfaces.</p><p><img src=select-networks.png alt=img></p><ul><li>The destination network for the first network interface will be the network designated for the node’s management interface. If you opted for a single interface configuration, you will only need this interface connected.</li><li>The destination network for the second network interface will be the network designated for the node’s data interface. If you opted for a single interface configuration you will still need to provide a port group for this to complete the deployment but it can be disconnected after deployment</li></ul></li><li><p>Verify the configuration data and click Finish to deploy the VM</p><p><img src=complete.png alt=img></p></li><li><p>Once your VM Template has finished deployment, power on the VM</p></li></ol><p>Deployment of your Trustgrid gateway node VM is now complete. If configuring this Node as a gateway, the next step will be to allow inbound TCP port 8443 to your gateway VM to allow remote nodes to connect back to it.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-88919b6dfe830981110e41698ff5dbac>7.7 - On a Stick Configuration</h1><div class="pageinfo pageinfo-primary"><p>Edge nodes can be configured in an &ldquo;on a stick&rdquo; configuration, in which only a single NIC is used for each node. Operating in this mode is supported only when using Layer 3 or Layer 4 configuration where hosts behind gateway nodes need access to data behind edge nodes.</p></div><p>In this configuration, the source IP of traffic from the edge node depends on whether Layer 3 or Layer 4 is being used, as illustrated below.</p><h3 id=layer-3>Layer 3</h3><p>Traffic will originate only from the current active node from the IP address(es) specified in outside NAT rules in the edge node&rsquo;s config.</p><p><img src=l3-stick.png alt=img></p><h3 id=layer-3---routed-single-edge-node>Layer 3 - routed single edge node</h3><p>Trustgrid node(s) used as the next hop in a route for the Trustgrid virtual network. Traffic at the edge will originate from the node&rsquo;s IP address.</p><p><img src=l3-routed.png alt=img></p><h3 id=layer-4>Layer 4</h3><p>Traffic will originate from either edge node with round-robin load-balancing with the source IP address being the IP address of whichever node the traffic originates from.</p><p><img src=l4-stick.png alt=img></p></div><div class=td-content style=page-break-before:always><h1 id=pg-1fca8ca5bcf5316ac2d6ec6d6750f674>8 - Enable SAML with Okta</h1><p>In Okta, switch to the Classic UI to be able to configure SAML applications.</p><p>Further Information on configuring SAML Application in Okta Classic UI: <a href=https://developer.okta.com/standards/SAML/setting_up_a_saml_application_in_okta/>https://developer.okta.com/standards/SAML/setting_up_a_saml_application_in_okta/</a></p><p><img src=okta.png alt=img></p><p>Create an Application, then select <code>Web</code> and <code>SAML 2.0</code>.</p><p><img src=okta2.png alt=img></p><p>When configuring SAML, enter the <a href=https://portal.trustgrid.io/saml>Trustgrid Portal</a> and select <code>EmailAddress</code> for Name ID format and <code>Email</code> for Application username.</p><p><img src=saml-settings.png alt=img></p><p>Complete the following survey questions and then download the IDP Metadata XML File by clicking on Identity Provider Metadata link. This will open up the xml file as shown below. Save this XML file and provide it to Trustgrid Support.</p><p>Additionally you will also need to provide a subdomain that will be used as the login URL only for SAML users. For example the subdomain must be subdomain.trustgrid.io. Any Okta Users going to <a href=https://subdomain.trustgrid.io>https://subdomain.trustgrid.io</a> will be directed to the Okta Login Page and authenticate with their Okta credentials. Once authenticated successfully they will be logged into the Trustgrid Portal. Note that if for any reason SAML authentication is failing you may always fall back to the Trustgrid portal local authentication by navigating to <a href=https://portal.trustgrid.io>https://portal.trustgrid.io</a> and using your Trustgrid portal user credentials. All users that are going to use Okta to login to the Trustgrid portal will need to be associated with the Trustgrid Okta SAML Application.</p><p>Reference for assigning users to Okta SAML Application: <a href=https://developer.okta.com/standards/SAML/setting_up_a_saml_application_in_okta>https://developer.okta.com/standards/SAML/setting_up_a_saml_application_in_okta</a></p><p>Once both the XML file and subdomain have been received by Trustgrid Support it will be configured in the Trustgrid Portal.</p><p><img src=sign-on.png alt=img></p><p><img src=long-code.png alt=img></p><h4 id=adding-saml-users>Adding SAML Users</h4><p>After enabling SAML you can add users following the process below:</p><ol><li>In Okta, add the user either to the Trustgrid application directly or to a group that includes access to the Trustgrid application</li><li>In the Trustgrid portal, invite the Trustgrid user using their primary email address in Okta</li><li>The users should receive an email with a link that directs them to <a href=https://subdomain.trustgrid.io>https://subdomain.trustgrid.io</a> but they can navigate there directly. Subdomain will be whatever was provided to Trustgrid support as they enabled SAML.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-becedbc7d009f334b2a4971e441bf158>9 - Find the IP Adress of a Node</h1><ol><li><p>Go to the <code>Node</code> detail page for the node in question</p></li><li><p>There are several IP addresses reported:</p><p>a. In the top table, <code>IP Address</code> is the egress IP address that the node is using to communicate with the management plane</p><p>b. In the shadow table, the IP addresses for all non-loopback interfaces are shown</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-e958de7e80893c30582f24e6a0941be7>10 - Gateway Tools</h1></div><div class=td-content><h1 id=pg-8bb544fcf510b6cbff2d42ef2a56ae83>10.1 - Monitoring Network Hops to Peers</h1><div class="pageinfo pageinfo-primary"><p>This feature collects traceroute-like data to all its connected peers and stores the results in the Trustgrid cloud for historical review.</p></div><div class="alert alert-info" role=alert>Network hop monitoring requires version 20220808 or newer to gather the required data.</div><h2 id=how-it-works>How it Works</h2><ol><li>The node will send out packets to each peer&rsquo;s public IP and port (if a gateway) with incrementing Time To Live (TTL) values.</li><li>As the packets pass through each router (or hop) along the way the TTL is decreased by one.</li><li>Any time a router receives a packet with at TTL with the value 1 it will drop the packet and can reply with an ICMP packet saying “Time to Live has been exceeded”</li><li>The node uses these ICMP packets to calculate latency to each hop.</li></ol><h2 id=known-limitations>Known Limitations</h2><p>There are several known limitations with gathering this data:</p><ul><li>Routers on the internet are not required to respond with ICMP. This will lead to gaps in the Hop numbers.</li><li>Those that do respond sometimes deprioritize their response which leads to misleading latency numbers.</li><li><ul><li>If you see a hop with high values, but the the values for higher hop numbers is normal this is not likely the cause of problems</li></ul></li><li><ul><li><strong>If a hop has high values and all subsequent hops have higher values this is likely the source of the latency/loss</strong></li></ul></li><li>Firewall rules have to allow the packets and the responses.</li><li><ul><li>By utilizing the same TCP port as the gateway, all data collected from edge nodes should be allowed out.</li></ul></li><li><ul><li>Some firewalls/routers have trouble correlating the TCP request with the ICMP response which leads to no data</li></ul></li><li>Gathering this data requires compute resources on the node and the gateway. Trustgrid recommends only enabling on edge nodes that have frequent latency or packet loss issues as a troubleshooting tool.</li></ul><div class="alert alert-warning" role=alert>It is not recommended to enable this feature on public gateways or private gateways with a large number of clients</div><h2 id=enabling-network-hop-monitoring>Enabling Network Hop Monitoring</h2><ol><li>Navigate to the node you want to enable</li><li>Verify there version is 20220808 or higher <img src=version-check.png alt=img></li><li>Navigate to <code>Gateway</code> under the <code>System</code> section</li><li>Enable <code>Network Hop Monitoring</code> and click <code>Save</code> <img src=enable-monitor-hops.png alt=img></li></ol><h2 id=special-considerations>Special Considerations</h2><h3 id=azure-nodes>Azure Nodes</h3><p>If you enable this on an <strong>edge</strong> node running on an Azure VM, the default security group rules will prevent responses from intermediate hops on the path. You will still get data from the final hop, which is the target gateway.</p><p>You will need to add an inbound rule to the node&rsquo;s public interface network security group.</p><p>The rule needs the settings shown below:</p><p><img src=azure-sg.png alt=img></p><div class="alert alert-warning" role=alert>The rule has to allow the destination of any which is not without risk. Make you weight the risks and benefits and are aware what VMs in Azure are using the same security group.</div><h2 id=viewing-network-hop-data>Viewing Network Hop Data</h2><ol><li>Navigate to the node you want to view</li><li>Select <code>Data Plane</code> on the left</li><li>Select the peer you wish to view data for. You will see a table of hops appear in the bottom right. <img src=network-hops.png alt=img></li><li>You can select a time point on the latency chart, and the hops table will update to show the data for that time point. <img src=monitoring.png alt=img></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-45e1ca7a969bfc66666b285166ff38f7>10.2 - Ping Remote Node</h1><div class="pageinfo pageinfo-primary"><p>This tool runs a ping from the gateway node to a remote edge node to verify the Trustgrid overlay network is functioning as expected.</p></div><h2 id=usage>Usage</h2><ol><li><p>Navigate to the node from which you want to test connectivity.</p></li><li><p>Click the <code>Data Plane</code> link on the left hand side.</p></li><li><p>Among the gateways (in the case of an edge node) or edge nodes (in the case of a gateway), click <code>Ping</code> on the row of the node you want to test.</p><p><img src=ping-remote-node.png alt=img></p></li><li><p>A modal will pop up with options. Click <code>Execute</code> to start the ping.</p><p><img src=ping-modal.png alt=img></p></li><li><p>A window will pop up with the ping output. You can adjust the interval to change the time between pings (in seconds), and the size to change how much data is sent.</p><p><img src=ping-output.png alt=img></p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-5f10d06e90d426e0577b9ecf0948abf8>11 - Limit Node Functionality to Current Public IP</h1><div class="pageinfo pageinfo-primary"><p>This security feature allows restricting node functionality to the current public IP address. If the public IP changes the data plane connectivity will cease to function and no data plane traffic will pass. It is the equivalent to disabling a node in the trustgrid portal. This feature should not be used on networks where the Public IP is controlled via DHCP. It should only be used where the public address is statically assigned to the node and is not expected to change.</p></div><h6 id=process-to-restrict>Process to Restrict</h6><ul><li>Click <code>Info</code> in the top right corner of the page, or click the backtick key (`) to show the menu</li><li>Click the padlock button next to Public IP to lock (Do not enable if using DHCP. Static addresses only)</li></ul><p><img src=unlocked1.png alt=img></p><ul><li>Public IP should now show padlock icon as locked as shown below</li></ul><p><img src=locked1.png alt=img></p><ul><li>Click the padlock again to remove the restriction at any point.</li></ul><h6 id=alerts>Alerts:</h6><p>Once locked changing the Public IP of the node will result in an alert being generated as seen belo. At this point no data plane traffic will be allowed.</p><p><img src=alert-node-public-ip.png alt=img></p></div><div class=td-content style=page-break-before:always><h1 id=pg-18be48e8b87be45f32e42c6a76ceb0dd>12 - Remote Tools</h1></div><div class=td-content><h1 id=pg-645ef0365cda0722e81c624f870ffe98>12.1 - Ping Remote Virtual Host</h1><div class=lead>Ping a remote virtual host from a node</div><h2 id=prerequisites>Prerequisites</h2><ul><li>Both the source and destination nodes should have a virtual management IP configured<ul><li>There should be a unique IP under Node > Configuration > VPN > Virtual Management IP</li><li>In the virtual network route configuration in your domain, a route should exist with the following settings:<ul><li>Destination: node name (even if part of a cluster)</li><li>Destination CIDR: virtual management IP with a /32 suffix</li><li>Metric: 1</li></ul></li><li>Use the <a href=https://docs.trustgrid.io/tutorials/remote-tools/view-virtual-route-table/>View Virtual Route Table</a> tool to verify both the source and destination nodes have valid, available routes to each other&rsquo;s virtual management IP</li></ul></li><li>Need to know the virtual IP address of the inside NAT if targeting a local IP on the destination network</li><li>Need to know the virtual management IP address of the destination node if only verifying VPN network connectivity</li></ul><div class="alert alert-info" role=alert>The <a href=https://docs.trustgrid.io/tutorials/gateway-tools/ping-remote-node/>Ping Remote Node</a> tool allows you to verify data plane communication by node name</div><h2 id=usage>Usage</h2><ol><li><p>Login to the Trustgrid portal and navigate to the Node from which you want to test connectivity.</p></li><li><p>Select <code>VPN</code> under the <code>Network</code> section.</p></li><li><p>Click the <code>Tools</code> button and select the <code>Ping Remote Virtual Host</code> option from the <code>Select a service</code> dropdown.</p><p><img src=ping-remote-modal.png alt="Ping Remote Host Dialog"></p></li><li><p>Modify the host parameter to the target virtual IP address and click <code>Execute</code>.</p></li><li><p>A window will pop up with the content like below.</p><p><img src=ping-output.png alt="Ping Output"></p></li></ol><h2 id=responses>Responses</h2><p>There are several configuration elements that need to be configured and working for a VPN deployment to be successful. When something is not configured correctly, the trustgrid node responds to an ICMP ping with a variety of different &ldquo;Destination Unreachable&rdquo; error messages that can indicate what exactly appears to be wrong. Here are the error responses the node may give when attempting to ping a remote machine through the VPN when something is amiss.</p><h3 id=destination-net-unknown>Destination Net Unknown</h3><p>This error means that the node cannot find an interface network binding with an inside and outside nat that match the requests source and destination IP. You should re-examine the inside and outside nats for the node interface that is receiving the packet, and make sure that an inside nat is defined that matches the source machines local IP and an outside nat that matches the virtual destination IP (or that no outside nat is present, which defaults to 1x1).</p><h3 id=destination-net-unreachable>Destination Net Unreachable</h3><p>This error means that the node cannot find a route defined at the domain/network level for the destination IP in this request. You should examine the domain route definitions and make sure that one is included for the virtual destination IP address you are trying to ping. Use the <a href=https://docs.trustgrid.io/tutorials/remote-tools/view-virtual-route-table/>View Virtual Route Table</a> tool using the target IP as a filter to confirm the route exists and is available.</p><h3 id=destination-host-unreachable>Destination Host Unreachable</h3><p>This error indicates that there is a route defined for the ping dest IP, but that the destination node associated with the route is not currently connected to this node. You should look at the routes in the source node&rsquo;s detail page in the portal and make sure that there is one included for the destination node that should be receiving the request.</p><h3 id=packet-filtered>Packet Filtered</h3><p>This error results when the ping request could not be performed do to the lack of a domain network ACL allowing the request. While this itself only indicates that ICMP traffic is not allowed between these two hosts in this direction, it can be used as a valuable indicator of a bigger policy issue. Check your ACL list in the portal to ensure that icmp are allowed between these to hosts.</p><h3 id=destination-host-unknown>Destination Host Unknown</h3><p>This error happens when the ping packet made it to the destination node, but no set of inside/outside nats could be found that include the source and destination IPs of this request. Check the destination node VPN settings to ensure an inside NAT is present for the virtual destination IP of the request, and either an outside NAT exists and includes the virtual source IP, or no outside NAT is present, which defaults to 1x1.</p><h3 id=no-ping-response-error>No Ping Response Error</h3><p>When a ping sits there and no response is received, usually the best way to troubleshoot further is to <a href=https://docs.trustgrid.io/tutorials/remote-tools/sniff-interface-traffic/>sniff interface traffic</a> with a filter of <code>icmp and host &lt;target-ip></code> on the source and dest nodes.</p><p>When troubleshooting, keep in mind that the lack of an error likely means one of the following:</p><ol><li>The local node VPN interface that should be receiving the packet hasn&rsquo;t been configured correctly.</li><li>The local firewall, router or target machine isn&rsquo;t correctly routing packets to the source node.</li><li>There is an ARP issue on either the source or destination node where the node isn&rsquo;t responding correctly (<code>tcpdump -i &lt;data_nic> arp</code>)</li><li>There is no responding machine on the remote side!</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-51c069fcffd3733d792696227fec123b>12.2 - Sniff Interface Traffic</h1><div class="pageinfo pageinfo-primary"><p>The sniff interface traffic tool performs a traffic capture on the selected node, which can help troubleshoot connectivity issues.</p></div><h2 id=summary>Summary</h2><p>The Sniff Interface Traffic tool allows you to monitor traffic in real-time but there are certain instances where you need to be able to capture traffic to a file for further analysis. For example, intermittent issues may require leaving a capture running for an unknown period of time. Or, perhaps you need to review the application data within the packet payload.</p><p>The Traffic Capture is started with a standard tcpdump filter, just like the sniff interface tool, and max capture file size. Once the capture is stopped the captured data is written to .pcap files which can then be transferred for review.</p><div class="alert alert-warning" role=alert>The pcap files will include the data payload of any communication captured. If a non-encrypted protocol (such as HTTP or FTP) is used this could be visible in clear text.</div><p>Because of the risk of data being visible, there are several restrictions and controls in place:</p><ol><li>The permission to run this tool (<code>node-advanced::service:tg-capture</code>) must be granted on a per-user basis. Not even administrators have this feature by default.
<img src=pcap-permissions.png alt=img></li><li>Trustgrid employees are specifically denied the ability to run this tool. Trustgrid employees are not permitted to view data transferred through our devices, so please do not send us the resulting pcap files.</li></ol><h2 id=accessing--using-sniff-interface-traffic>Accessing & Using Sniff Interface Traffic</h2><ol><li><p>Login to the Trustgrid portal and navigate to the Node from which you want to capture traffic.</p></li><li><p>Select <code>Interfaces</code> under the <code>Network</code> section.</p></li><li><p>Click the Sniff Traffic button</p><p><img src=network-tools.png alt=img></p></li><li><p>Set the appropriate parameters.<br><tr id=iface><th>iface</th><td>The interface name</td></tr><tr id=filter><th>filter</th><td>The tool utilizes <a href=https://www.tcpdump.org/manpages/pcap-filter.7.html>TCPDump filtering syntax</a>, which can help isolate interesting traffic. The below filter would show only ICMP and TCP traffic</td></tr><img src=filters.png alt=img></p></li><li><p>Click <code>Execute</code> to view the captured traffic</p></li></ol><p><img src=sniff-output.png alt=img></p><h2 id=transfer-pcap-files>Transfer PCAP Files</h2><p>Now that you have created the pcap files you will need to transfer them somewhere for analysis. The Trustgrid node has standard file transfer clients installed including scp, sftp, and ftp.</p><h3 id=on-a-local-network>On a Local Network</h3><p>If the destination file server is on the local network of the node you will use the standard Terminal tool to run the file transfer commands.</p><ol><li>Navigate to the node</li><li>Open a terminal from the toolbar at the top right</li></ol><p>You will need to ensure that:</p><ul><li>The node has a valid route to the destination server&rsquo;s network</li><li>Any firewall between the node and destination server allows the traffic</li><li>The destination server is configured to allow the node IP to connect</li></ul><p>Once you are in the terminal with the above configured an example scp command would look something like <code>scp ~/captures/capture-2021-07-16_17-59-23.pcap0 username@172.16.100.10:/captures/capture-2021-07-16_17-59-23.pcap</code>.</p><h3 id=across-the-virtual-network>Across the Virtual Network</h3><p>If the destination file server is across a Trustgrid virtual network you will need to use the VPN Admin terminal to run the file transfer commands. This uses the nodes configured Virtual Management IP to communicate to remote resources.</p><ol><li><p>Navigate to the node</p></li><li><p>Select the VPN panel. You may need to select the virtual network to use, if your device is connected to multiple.</p></li><li><p>Select the <code>Admin Terminal</code> button from the tools dropdown.</p><p><img src=admin-terminal.png alt=img></p></li></ol><p>You will need to ensure that:</p><ul><li>The node has a virtual management IP assigned. The tool will not launch without this.</li><li>A route for the virtual management IP exists in the virtual network route table.</li><li>On the destination node, that a 1:1 NAT exists for the destination file server assigning it to a virtual IP.</li><li>A route that includes the destination file server&rsquo;s VIP exists in the network route table.</li><li>A virtual network access policy exists that allows the source node&rsquo;s virtual management IP to connect to the destination file server&rsquo;s VIP on the required port for your protocol.</li><li>The destination side node has a valid route to the destination server&rsquo;s network.</li><li>Any firewall between the node and destination server allows the traffic.</li><li>The destination is configured to allow the node IP to connect.</li></ul><p>Once you are in the admin terminal with the above configured, an example SCP command would look like <code>scp ~/captures/capture-2021-07-16_17-59-23.pcap0 username@10.200.100.10:/captures/capture-2021-07-16_17-59-23.pcap</code>.</p><h2 id=useful-filters>Useful Filters</h2><p>The below filters can be combined using &ldquo;and&rdquo; & &ldquo;or&rdquo; without quotes</p><ul><li>You can filter based on protocol such as &ldquo;tcp&rdquo;, &ldquo;udp&rdquo;, or &ldquo;icmp&rdquo; without quotes</li><li>Best practice is to filter for what you want to see rather than filter out what you don&rsquo;t want to see</li><li>To see only traffic for a specific host use &ldquo;host x.x.x.x&rdquo; with the IP address in place of the x.x.x.x</li><li>To see only traffic for a specific port use &ldquo;port XXXX&rdquo; replacing the XXXX with the desired port number</li><li>If capturing traffic on a clustered node, you should filter out the cluster port traffic. Typically port 9000 or 1975. E.g., <code>not port 9000</code></li><li>If capturing on the ETH0 - WAN Interface, you should filter out traffic to both Trustgrid&rsquo;s network (35.171.100.16/28) and your data plane gateways&rsquo; network or public IP. You&rsquo;ll need to identify the actual network or IPs. E.g., <code>not net 35.171.100.16/28 and not net X.X.X.X/X</code> or <code>not net 35.171.100.16/28 and not host X.X.X.X</code>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ff566379924693f5bd0c70a6b09efa37>12.3 - TCP Port Test</h1><div class="pageinfo pageinfo-primary"><p>The TCP Port Test tool initiates a TCP session with a target IP address and port to confirm fully layer 4 connectivity. This would be similar to using netcat or telnet to test connectivity to a TCP port.</p></div><h2 id=usage>Usage</h2><ol><li><p>Login to the Trustgrid portal and navigate to the Node from which you want to test connectivity.</p></li><li><p>Select <code>Interfaces</code> under the <code>Network</code> section.</p></li><li><p>Click the <code>Interface TCP Port Test</code> button</p><p><img src=network-tools.png alt=img></p></li><li><p>Update the host with the target IP address and the port with the target TCP port. Click <code>Execute</code> to test connectivity.</p><p><img src=config.png alt=img></p></li><li><p>A new window will open with the results. If a new window does not open, check your browser&rsquo;s pop-up blocker settings.</p><p>A successful test will look like this:</p><p><img src=success.png alt=img></p><p>A failed connection will look like this:</p><p><img src=failed.png alt=img></p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-099456662cc8248096dacdebd11257e5>12.4 - View Virtual Route Table</h1><div class=lead>View the routing table on a node</div><h2 id=usage>Usage</h2><ol><li><p>Login to the Trustgrid portal and navigate to the Node from which you want to test connectivity.</p></li><li><p>Select <code>VPN</code> under the <code>Network</code> section.</p></li><li><p>Click the <code>Tools</code> button and click the <code>View Virtual Routes</code> button</p><p><img src=network-tools.png alt="Virtual Network Tools"></p></li><li><p>A table will appear with routing information for the node.</p><p><img src=virtual-route-table.png alt="Virtual Route Table"></p></li></ol><h2 id=analyzing-the-route-table>Analyzing the Route Table</h2><h3 id=route-availability>Route Availability</h3><p>If a route is available, its <code>Active</code> column will show a green up arrow (<i class="fa-solid fa-arrow-up" style=color:green></i>). If a route is not available, its <code>Active</code> column will show a red down arrow (<i class="fa-solid fa-arrow-down" style=color:red></i>).</p><h3 id=route-preference>Route Preference</h3><p>Routes will be selected based on the following order:</p><ol><li>In overlapping routes, the most specific route wins. For example, 10.20.0.51/32 takes precedence over 10.20.0.0/24.</li><li>If multiple matching routes exist, the route with the lowest metric wins. For example, a metric of 1 takes precedence over a metric of 50.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-ec55fe3fdd6af3991bc421eeffbaf0b2>13 - Trustgrid Local Console Utility</h1><div class="pageinfo pageinfo-primary"><p>The Trustgrid node console allows local console access to a Trustgrid Node whether a physical or esx node for the purposes of IP reconfiguration or network level troubleshooting and verification.</p></div><h3 id=accessing-the-trustgrid-console-utility>Accessing the Trustgrid Console Utility</h3><h4 id=connecting-to-trustgrid-local-console>Connecting to Trustgrid Local Console</h4><ul><li>The following physical nodes can be connected via Keyboard and Monitor<ul><li>Netgate - HDMI Monitor output, USB Keyboard</li><li>Protectli RM8B - VGA Monitor output, USB Keyboard</li><li>Dell Precision 3240 compact - DisplayPort Monitor Output, USB Keyboard</li></ul></li><li>The following devices support connecting a serial cable connected to a laptop/desktop with the settings in the table below</li></ul><table><thead><tr><th>Device</th><th>Serial Port Type</th><th>Speed (bps)</th><th>Data Bits</th><th>Parity</th><th>Stop Bits</th><th>Flow Control</th></tr></thead><tbody><tr><td>Lanner NCA-1210</td><td>RJ45</td><td>115200</td><td>8</td><td>None</td><td>1</td><td>None</td></tr><tr><td>Lanner NCA-1515</td><td>RJ45</td><td>115200</td><td>8</td><td>None</td><td>1</td><td>None</td></tr></tbody></table><hr><ul><li>VMware and Hyper-V based nodes can utilize the native console tools for each respective platform</li><li>Node console is not supported on AWS nodes</li></ul><h4 id=logging-in>Logging In</h4><ul><li><p>Login with username tgadmin and password of mac address of the wan nic of the device all lowercase including colons. Example 82:f5:48:a9:14:05</p></li><li><p>The mac address can be seen on the node page in the shadow. Depending on device type it will be enp2s0 for netgate / enp0s20f1 for lanner or ens160 for esx.</p></li></ul><h3 id=trustgrid-local-console-dashboard>Trustgrid Local Console Dashboard</h3><p>As seen below the console dashboard displays information on the current version of software the node is currently running as well as the connectivity/network status.</p><p>The first screenshot shows a healthy node that is able to successfully resolve public DNS names and connect to Trustgrid’s control plane. The second screenshot shows a node that is able to resolve DNS but unable to connect to the Trustgrid Control Plane.</p><p><img src=node-console-1.png alt=img></p><p><img src=node-console-2.png alt=img></p><h3 id=changing-a-trustgrid-node-wan-ip-via-trustgrid-console>Changing a Trustgrid Node WAN IP via Trustgrid Console</h3><blockquote><p>After the IP address is changed locally it must connect to the Trustgrid Cloud Controller and the new IP address must be saved in the portal to make the change permanent. If the device is rebooted prior to that it will revert to the previous configuration.
To change the nodes WAN IP address select option 1.</p></blockquote><p>Configure new static IP or select DHCP and select ok to save the changes. The IP should be updated in the Trustgrid Portal when the IP is changed. There will be a prompt in the portal to import the new IP settings.</p><p><img src=node-console-3.png alt=img></p><p><img src=node-console-4.png alt=img></p><p><img src=node-setup.png alt=img></p><p><img src=network-update.png alt=img></p><p>After the IP address has been changed and the device connects to the Trustgrid control plane the new IP configuration will need to be imported and saved. If you do not have portal access please work with Trustgrid Support</p><p><img src=configuration-network.png alt=img></p><h3 id=changing-the-default-password>Changing the Default Password</h3><p>The tgadmin user’s password can be changed by selecting option 3.</p><p>You will then need to enter the current password (mac address of wan nic all lowercase with colons) followed by the new password.</p><p><img src=password-thing.png alt=img></p><blockquote><p>After this password is changed it can only be reset if the device successfully connects to the Trustgrid control plane. Please ensure the password is appropriately documented for future use.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-b3b99a158d5908d67bad599d7a396e50>14 - Trustgrid Local UI for Node IP Reconfiguration</h1><div class="pageinfo pageinfo-primary"><p>The Trustgrid UI can be used to change the management IP or DNS servers configured on the Trustgrid node. It can also be used to confirm connectivity of the device to various Trustgrid services.</p></div><h6 id=requirements>Requirements:</h6><ol><li>Physical access to the Trustgrid Node</li><li>Laptop or Desktop with web browser (preferably Chrome) and network card (NIC)</li><li>Ethernet Cable</li></ol><h6 id=steps-to-access-the-trustgrid-ui-to-update-management-ip-or-dns-servers>Steps to Access the Trustgrid UI to Update Management IP or DNS Servers:</h6><p>Local UI IP addresses</p><table><thead><tr><th>Interface Label</th><th>Local UI Website</th><th>Attached Device IP</th></tr></thead><tbody><tr><td>Netgate - ETH1<br>Lanner 1210 - LAN2<br>Lanner 1515 Fiber WAN -SPF2<br>Lanner 1515 RJ45 WAN - SPF1<br></td><td>https://169.254.<strong>1</strong>.234</td><td>169.254.<strong>1</strong>.1/24</td></tr><tr><td>Lanner 1210 - LAN3<br>Lanner 1515 Fiber WAN - LAN3<br>Lanner 1515 RJ45 WAN - SFP2<br></td><td>https://169.254.<strong>2</strong>.234</td><td>169.254.<strong>2</strong>.1/24</td></tr><tr><td>Lanner 1210 - LAN4<br>Lanner 1515 Fiber WAN - LAN4<br>Lanner 1515 RJ45 WAN - LAN4<br></td><td>https://169.254.<strong>3</strong>.234</td><td>169.254.<strong>3</strong>.1/24</td></tr><tr><td>Lanner 1515 Fiber WAN - LAN5<br>Lanner 1515 RJ45 WAN - LAN5<br></td><td>https://169.254.<strong>4</strong>.234</td><td>169.254.<strong>4</strong>.1/24</td></tr><tr><td>Lanner 1515 Fiber WAN - LAN6<br>Lanner 1515 RJ45 WAN - LAN6</br></td><td>https://169.254.<strong>5</strong>.234</td><td>169.254.<strong>5</strong>.1/24</td></tbody></table><ol><li><p>Disable the node in the Trustgrid Portal. This will disrupt and disable all data plane communication on the node.</p></li><li><p>Make sure the ETH0/LAN1 interfaces is connected to a network device.</p><p>a. Ideally connected to the desired switch port so we can confirm status after changes, but at minimum it must have &ldquo;link&rdquo;</p></li><li><p>Reboot the Trustgrid Node by power cycling the device</p></li><li><p>Connect your laptop/desktop NIC to one of the available interfaces (refer to the table above)</p></li><li><p>Configure a laptop/desktop NIC with the corresponding &ldquo;Attached Device IP&rdquo; from the table above</p></li><li><p>In a web browser (Chrome preferred) navigate to the corresponding Local UI Website from the table above. Note: you will get an SSL warning which is safe to accept the self-signed certificate</p></li><li><p>On a successful connection, you will be at the Trustgrid UI Login Screen. The username is &ldquo;admin&rdquo; and the password is the mac address (lowercase) listed on the sticker on the bottom of the node as seen below. This must include colons between every two characters. For example the password for the device pictured below would be 00:08:a2:0b:cd:30 all lowercase.</p></li></ol><p><img src=login.png alt=img> <img src=sticker.png alt=img></p><ol><li>Upon successful login you will see the <code>Network Status</code> page shown below. This shows the current connectivity status of various Trustgrid services. Green means connectivity is established and red means it is not.</li></ol><p><img src=red-status.png alt=img><img src=green-status.png alt=img></p><ol><li>Select <code>Management Interface</code> (shown below) on the left hand side of page. You can then edit the IP Address/Netmask/Gateway and DNS Servers configured. Once the relevant changes have been made click on <code>Apply</code> and then click <code>Save</code>.</li></ol><p><img src=management-interface.png alt=img></p><ol><li><p>Check the network status page to see if the Trustgrid services turn green. If they do then cable the node back as expected.</p></li><li><p>Contact Trustgrid support and communicate the IP information configured above so they can update the configuration in the portal and enable the node.</p></li></ol><div class="alert alert-primary" role=alert>If the old IP information remains in the portal the device may revert the local configuration requiring a repeat of the above process.</div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=LinkedIn aria-label=LinkedIn><a class=text-white target=_blank rel=noopener href=https://www.linkedin.com/company/trustgrid/ aria-label=LinkedIn><i class="fab fa-linkedin"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/trustgrid aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 Trustgrid All Rights Reserved</small>
<small class=ml-1><a href=https://trustgrid.io target=_blank rel=noopener>Privacy Policy</a></small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/mermaid@9.2.2/dist/mermaid.min.js integrity="sha512-IX+bU+wShHqfqaMHLMrtwi4nK6W/Z+QdZoL4kPNtRxI2wCLyHPMAdl3a43Fv1Foqv4AP+aiW6hg1dcrTt3xc+Q==" crossorigin=anonymous></script>
<script src=/js/main.min.eb0d5914014c9e8699b3e0109eff69ebdcde4f5e0c80993229a0ebfa76596d0b.js integrity="sha256-6w1ZFAFMnoaZs+AQnv9p69zeT14MgJkyKaDr+nZZbQs=" crossorigin=anonymous></script>
<script src=/js/prism.js></script>
<script src=/js/tabpane-persist.js></script></body></html>